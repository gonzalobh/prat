<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Consulta mÃ©dica Â· OrientaciÃ³n y cuidado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Asistente mÃ©dico para orientar sobre sÃ­ntomas, cuidados generales y seÃ±ales de alarma con un lenguaje claro y humano." />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root {
      --font-display: 'Playfair Display', serif;
      --font-body: 'Inter', 'Neue Haas Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --color-night: #fbfaf5; /* // ğŸ¨ estilo clÃ­nico */
      --color-obsidian: #f5f6f0; /* // ğŸ¨ estilo clÃ­nico */
      --color-carbon: #eef1e8; /* // ğŸ¨ estilo clÃ­nico */
      --color-graphite: #e7ece2; /* // ğŸ¨ estilo clÃ­nico */
      --color-porcelain: #ffffff; /* // ğŸ¨ estilo clÃ­nico */
      --color-ivory: #f9faf7; /* // ğŸ¨ estilo clÃ­nico */
      --color-ink: #1f2a44; /* // ğŸ¨ estilo clÃ­nico */
      --color-muted: #6b7280; /* // ğŸ¨ estilo clÃ­nico */
      --color-muted-dark: #8b94a6; /* // ğŸ¨ estilo clÃ­nico */
      --color-accent: #c9ddb6; /* // ğŸ¨ estilo clÃ­nico */
      --color-accent-soft: #d6e6c3; /* // ğŸ¨ estilo clÃ­nico */
      --shadow-veil: 0 28px 70px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
      --shadow-panel: 0 22px 50px rgba(31, 42, 68, 0.1); /* // ğŸ¨ estilo clÃ­nico */
      --shadow-hover: 0 26px 70px rgba(31, 42, 68, 0.14); /* // ğŸ¨ estilo clÃ­nico */
      --radius-xl: 32px;
      --radius-lg: 28px;
      --radius-md: 22px;
      --transition-base: all 0.45s ease;
      --transition-soft: cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    html, body {
      height: 100%;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      overflow: hidden;
    }

    body {
      min-height: 100vh;
      min-height: -webkit-fill-available;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background:
        radial-gradient(circle at 18% 12%, rgba(201, 221, 182, 0.28), transparent 58%),
        radial-gradient(circle at 78% 0%, rgba(31, 42, 68, 0.08), transparent 60%),
        linear-gradient(160deg, var(--color-night), var(--color-obsidian) 55%, var(--color-ivory) 100%); /* // ğŸ¨ estilo clÃ­nico */
      color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
      font-family: var(--font-body);
      letter-spacing: 0.01em;
      line-height: 1.75; /* // ğŸ¨ estilo clÃ­nico */
      position: relative;
      overflow: hidden;
      transition: background 0.8s ease, color 0.6s ease;
    }

    body::before {
      content: '';
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 25% 30%, rgba(201, 221, 182, 0.22), transparent 55%),
        radial-gradient(circle at 80% 65%, rgba(255, 255, 255, 0.35), transparent 60%); /* // ğŸ¨ estilo clÃ­nico */
      pointer-events: none;
      mix-blend-mode: normal;
      opacity: 0.8; /* // ğŸ¨ estilo clÃ­nico */
      transition: opacity 0.8s ease;
    }

    body[data-theme="light"] {
      background:
        radial-gradient(circle at 18% 12%, rgba(201, 221, 182, 0.25), transparent 58%),
        linear-gradient(160deg, #fbfaf5, #f4f6ee 60%, #fbfaf5 100%); /* // ğŸ¨ estilo clÃ­nico */
      color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
    }

    body[data-theme="light"]::before {
      opacity: 0.55;
      background:
        radial-gradient(circle at 30% 25%, rgba(201, 221, 182, 0.3), transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.5), transparent 65%); /* // ğŸ¨ estilo clÃ­nico */
      mix-blend-mode: normal;
    }

    h1, h2, h3 {
      font-family: var(--font-display);
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    p {
      line-height: 1.8;
    }

    .desktop-shell {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 36px;
      max-width: 1360px;
      margin: 0 auto;
    }

    .desktop-shell > aside {
      display: none;
    }

    .hero-panel {
      display: none;
      flex-direction: column;
      justify-content: flex-start;
      gap: 26px;
      padding: clamp(28px, 4vw, 40px);
      background: rgba(255, 255, 255, 0.92); /* // ğŸ¨ estilo clÃ­nico */
      border: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      border-radius: var(--radius-xl);
      box-shadow: 0 22px 50px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
      max-width: 520px;
      position: relative;
      overflow: hidden;
    }

    .hero-panel::before {
      content: '';
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 10% 20%, rgba(201, 221, 182, 0.28), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(31, 42, 68, 0.08), transparent 50%); /* // ğŸ¨ estilo clÃ­nico */
      opacity: 0.6;
      pointer-events: none;
    }

    .hero-panel-content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .hero-panel-title {
      font-family: var(--font-display);
      font-size: clamp(28px, 2.6vw, 34px);
      text-transform: uppercase;
      letter-spacing: 0.24em;
    }

    .hero-panel-heading {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .hero-panel-subtitle {
      font-size: 16px;
      color: var(--color-muted); /* // ğŸ¨ estilo clÃ­nico */
    }

    .hero-panel-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .hero-panel-tag {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      background: rgba(255, 255, 255, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--color-muted); /* // ğŸ¨ estilo clÃ­nico */
    }

    .hero-panel-portrait {
      position: relative;
      z-index: 1;
      border-radius: 28px;
      overflow: hidden;
      border: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 20px 46px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
      aspect-ratio: 3 / 4;
    }

    .hero-panel-portrait img,
    .hero-panel-portrait video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center 12%;
      display: block;
    }

    .hero-panel-caption {
      position: relative;
      z-index: 1;
      font-size: 14px;
      color: var(--color-muted); /* // ğŸ¨ estilo clÃ­nico */
      border-left: 2px solid rgba(201, 221, 182, 0.7); /* // ğŸ¨ estilo clÃ­nico */
      padding-left: 12px;
      line-height: 1.7;
    }

    .chat-container {
      position: relative;
      width: 100%;
      max-width: 100vw;
      height: 100vh;
      min-height: -webkit-fill-available;
      background: rgba(251, 250, 245, 0.95); /* // ğŸ¨ estilo clÃ­nico */
      border-radius: 0;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      overflow: hidden;
      border: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      backdrop-filter: blur(16px); /* // ğŸ¨ estilo clÃ­nico */
      transition: transform 0.6s var(--transition-soft), background 0.8s ease, border-color 0.6s ease;
    }

    @media (max-width: 767px) {
      body {
        padding: env(safe-area-inset-top, 0px) env(safe-area-inset-right, 0px) env(safe-area-inset-bottom, 0px) env(safe-area-inset-left, 0px);
        display: block;
      }

      .chat-container {
        border-radius: 0;
        height: calc(100vh - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px));
        max-height: none;
        margin: 0 auto;
      }

@media (max-width: 767px) {
  .options-container.initial-options {
    flex-wrap: wrap;
    overflow-x: visible;
    justify-content: flex-start; /* â† alinea a la izquierda */
  }
}


      .options-container.initial-options .option-button {
        flex: 0 0 auto;
        scroll-snap-align: start;
      }

      .options-container.initial-options .option-button.toggle-button {
        position: sticky;
        right: 0;
      }
    }

    @supports (height: 100dvh) {
      html, body {
        min-height: 100dvh;
      }

      .chat-container {
        min-height: 100dvh;
        height: 100dvh;
      }

      @media (max-width: 767px) {
        .chat-container {
          height: calc(100dvh - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px));
        }
      }
    }

    @media (min-width: 768px) {
      body {
        padding: 28px;
      }

      .chat-container {
        height: 88vh;
        max-height: 880px;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-veil);
      }
    }

    @media (min-width: 1024px) {
      body {
        padding: 0;
      }

      .desktop-shell {
        align-items: center;
        justify-content: center;
        max-width: none;
        width: 100%;
        height: 100vh;
        margin: 0;
        padding: 24px;
      }

      .chat-container {
        width: min(1200px, 100%);
        flex: 0 1 min(1200px, 100%);
        max-width: 1200px;
        height: 88vh;
        min-height: 0;
        max-height: 880px;
        margin: 0 auto;
        padding-right: 0;
      }

      .header.hero-card {
        display: none;
      }

      .messages-container {
        padding: 26px 32px calc(96px + env(safe-area-inset-bottom, 0px));
        gap: 20px;
      }

      .message-bubble {
        max-width: 86%;
        font-size: 17px;
      }

      .message.user .message-bubble {
        max-width: 78%;
      }

      .header {
        padding: 0;
        min-height: 0;
        height: 0;
        border: 0;
        background: transparent;
        overflow: visible;
      }

      .header::before,
      .header::after {
        display: none;
      }

      .header-content {
        display: none;
      }

      .header-actions {
        position: fixed;
        top: 32px;
        right: 32px;
        padding: 8px 10px;
        z-index: 2000;
      }

      .input-zone {
        padding-top: 6px;
      }

      .input-container {
        padding: 18px 22px;
        padding-bottom: calc(18px + env(safe-area-inset-bottom, 0px));
        gap: 12px;
      }

      .message-input {
        padding: 14px 20px;
      }

      .send-button {
        width: 48px;
        height: 48px;
      }
    }

    body[data-theme="light"] .hero-panel {
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.94), rgba(244, 246, 238, 0.98)); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 30px 70px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
    }

    body[data-theme="light"] .hero-panel-title {
      color: var(--color-ink);
    }

    body[data-theme="light"] .hero-panel-subtitle,
    body[data-theme="light"] .hero-panel-caption,
    body[data-theme="light"] .hero-panel-tag {
      color: var(--color-muted); /* // ğŸ¨ estilo clÃ­nico */
    }

    body[data-theme="light"] .hero-panel-tag {
      background: rgba(255, 255, 255, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
    }

    body[data-theme="light"] .chat-container {
      background: rgba(251, 250, 245, 0.96); /* // ğŸ¨ estilo clÃ­nico */
      border: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 32px 70px rgba(31, 42, 68, 0.1); /* // ğŸ¨ estilo clÃ­nico */
      backdrop-filter: blur(16px); /* // ğŸ¨ estilo clÃ­nico */
    }

    .header {
      position: relative;
      padding: clamp(18px, 3vw, 26px) clamp(18px, 4vw, 32px) clamp(22px, 3.8vw, 30px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: clamp(18px, 4vw, 40px);
      flex-shrink: 0;
      min-height: clamp(96px, 20vw, 150px);
      background: linear-gradient(135deg, #fbfaf5 0%, #f5f6ef 45%, #ffffff 100%); /* // ğŸ¨ estilo clÃ­nico */
      overflow: visible;
      border-bottom: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
    }

    .header-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      position: relative;
      z-index: 2;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.85); /* // ğŸ¨ estilo clÃ­nico */
      border: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      backdrop-filter: blur(10px); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4); /* // ğŸ¨ estilo clÃ­nico */
    }

    @media (max-width: 480px) {
      .header {
        padding: 16px 18px 18px;
        gap: 12px;
        min-height: clamp(96px, 28vw, 120px);
      }

      .header-content {
        gap: 12px;
        min-width: 0;
      }

      .header-portrait {
        width: clamp(72px, 20vw, 84px);
        height: clamp(72px, 20vw, 84px);
        border-radius: 24px;
      }

      .header-titles {
        gap: clamp(4px, 1.2vw, 8px);
      }

      .header-title {
        font-size: clamp(18px, 5vw, 20px);
        letter-spacing: clamp(0.18em, 0.4vw, 0.22em);
      }

      .header-actions {
        gap: 6px;
        padding: 6px 8px;
      }

      .icon-button {
        width: 32px;
        height: 32px;
      }

    }

    .header::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle at 20% 20%, rgba(31, 42, 68, 0.06) 0.5px, transparent 0.6px),
        radial-gradient(circle at 80% 30%, rgba(31, 42, 68, 0.05) 0.5px, transparent 0.6px),
        radial-gradient(circle at 50% 70%, rgba(31, 42, 68, 0.04) 0.5px, transparent 0.6px); /* // ğŸ¨ estilo clÃ­nico */
      background-size: 120px 120px;
      opacity: 0.18; /* // ğŸ¨ estilo clÃ­nico */
      pointer-events: none;
      mix-blend-mode: normal; /* // ğŸ¨ estilo clÃ­nico */
    }

    .header::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 2px;
      background: linear-gradient(90deg, rgba(201, 221, 182, 0.6), rgba(229, 231, 235, 0.9), rgba(201, 221, 182, 0.6)); /* // ğŸ¨ estilo clÃ­nico */
      opacity: 0.6; /* // ğŸ¨ estilo clÃ­nico */
      pointer-events: none;
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: clamp(12px, 3vw, 22px);
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .header-actions {
      flex-shrink: 0;
    }

    .header-portrait {
      width: clamp(88px, 10vw, 110px);
      height: clamp(120px, 14vw, 150px);
      border-radius: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 18px 36px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
      transform: translateY(clamp(2px, 1vw, 6px));
    }

    .header-portrait::before {
      content: '';
      position: absolute;
      inset: -12px;
      border-radius: 32px;
      background: radial-gradient(circle, rgba(201, 221, 182, 0.35), transparent 60%); /* // ğŸ¨ estilo clÃ­nico */
      opacity: 0.6; /* // ğŸ¨ estilo clÃ­nico */
      z-index: 0;
    }

    .header-portrait img,
    .header-portrait video {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      object-fit: cover;
      display: block;
      position: relative;
      z-index: 1;
    }

    body[data-theme="light"] .header-portrait {
      border-color: rgba(177, 31, 45, 0.25);
      box-shadow: 0 18px 36px rgba(17, 32, 58, 0.2);
    }

    .header-titles {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      gap: 6px;
      min-width: 0;
    }

    .header-title {
      color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
      display: inline-flex;
      align-items: center;
      gap: clamp(6px, 1.4vw, 12px);
      font-size: clamp(20px, 2.8vw, 28px);
      letter-spacing: clamp(0.2em, 0.45vw, 0.28em);
      text-transform: uppercase;
      white-space: nowrap;
    }

    .header-flag {
      display: inline-flex;
      align-items: center;
      font-size: clamp(20px, 2.6vw, 28px);
      line-height: 1;
    }

    .header-title-text {
      white-space: nowrap;
    }

    .icon-button {
      position: relative;
      z-index: 1;
      width: 36px;
      height: 36px;
      border-radius: 18px;
      border: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      background: rgba(255, 255, 255, 0.92); /* // ğŸ¨ estilo clÃ­nico */
      color: #60705e; /* // ğŸ¨ estilo clÃ­nico */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.4s var(--transition-soft), border-color 0.4s ease, color 0.4s ease, background 0.6s ease;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4); /* // ğŸ¨ estilo clÃ­nico */
    }

    .icon-button:hover {
      transform: translateY(-3px);
      border-color: rgba(201, 221, 182, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      color: #47624d; /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 18px 40px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
    }

    .icon-button:focus-visible {
      outline: 2px solid var(--color-accent); /* // ğŸ¨ estilo clÃ­nico */
      outline-offset: 4px;
    }

    body[data-theme="light"] .icon-button {
      background: rgba(255, 255, 255, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      color: #60705e; /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4); /* // ğŸ¨ estilo clÃ­nico */
    }


    body[data-theme="light"] .header-actions {
      background: rgba(255, 255, 255, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4); /* // ğŸ¨ estilo clÃ­nico */
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 24px 20px calc(110px + env(safe-area-inset-bottom, 0px));
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
      position: relative;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    .chat-menu-wrapper {
      position: sticky;
      top: 16px;
      align-self: flex-end;
      margin-left: auto;
      z-index: 5;
    }

    .chat-menu-button {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(229, 231, 235, 0.9);
      background: rgba(255, 255, 255, 0.9);
      color: var(--color-muted);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      transition: transform 0.3s var(--transition-soft), border-color 0.3s ease, color 0.3s ease;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.5);
    }

    .chat-menu-button:hover {
      transform: translateY(-1px);
      border-color: rgba(201, 221, 182, 0.9);
      color: #4c6351;
    }

    .chat-menu-button:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 3px;
    }

    .chat-menu {
      position: absolute;
      top: 42px;
      right: 0;
      min-width: 230px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(229, 231, 235, 0.9);
      background: rgba(255, 255, 255, 0.96);
      box-shadow: 0 18px 45px rgba(31, 42, 68, 0.12);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-6px);
      transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
      pointer-events: none;
    }

    .chat-menu-wrapper.is-open .chat-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      pointer-events: auto;
    }

    .chat-menu-item {
      width: 100%;
      border: 0;
      background: rgba(201, 221, 182, 0.18);
      color: var(--color-ink);
      padding: 10px 12px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .chat-menu-item:hover {
      background: rgba(201, 221, 182, 0.3);
      transform: translateY(-1px);
    }

    .chat-menu-note {
      margin-top: 10px;
      font-size: 12px;
      color: var(--color-muted);
      line-height: 1.6;
    }

    .messages-container::-webkit-scrollbar {
      width: 6px;
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(201, 221, 182, 0.7), rgba(229, 231, 235, 0.7)); /* // ğŸ¨ estilo clÃ­nico */
      border-radius: 999px;
    }

    .floating-reset {
      position: absolute;
      bottom: calc(118px + env(safe-area-inset-bottom, 0px));
      right: clamp(18px, 5vw, 28px);
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.9), rgba(201, 221, 182, 0.4)); /* // ğŸ¨ estilo clÃ­nico */
      border: 1px solid rgba(201, 221, 182, 0.8); /* // ğŸ¨ estilo clÃ­nico */
      color: #5f7a58; /* // ğŸ¨ estilo clÃ­nico */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 20px 44px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
      backdrop-filter: blur(10px); /* // ğŸ¨ estilo clÃ­nico */
      cursor: pointer;
      transition: transform 0.35s ease, background 0.45s ease, border-color 0.45s ease,
        box-shadow 0.45s ease, color 0.4s ease;
      z-index: 1000;
    }

    .floating-reset svg {
      width: 24px;
      height: 24px;
      transition: transform 0.6s ease, filter 0.45s ease;
    }

    .floating-reset:hover {
      transform: scale(1.08);
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.95), rgba(201, 221, 182, 0.55)); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(201, 221, 182, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 24px 54px rgba(31, 42, 68, 0.16); /* // ğŸ¨ estilo clÃ­nico */
      color: #4d6750; /* // ğŸ¨ estilo clÃ­nico */
    }

    .floating-reset:focus-visible {
      outline: 2px solid var(--color-accent); /* // ğŸ¨ estilo clÃ­nico */
      outline-offset: 4px;
    }

    .floating-reset.spinning svg {
      transform: rotate(-360deg);
    }

    body[data-theme="light"] .floating-reset {
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.9), rgba(201, 221, 182, 0.4)); /* // ğŸ¨ estilo clÃ­nico */
      border: 1px solid rgba(201, 221, 182, 0.8); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 24px 48px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
      color: #5f7a58; /* // ğŸ¨ estilo clÃ­nico */
    }

    body[data-theme="light"] .floating-reset:hover {
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.95), rgba(201, 221, 182, 0.55)); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(201, 221, 182, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 28px 60px rgba(31, 42, 68, 0.16); /* // ğŸ¨ estilo clÃ­nico */
      color: #4d6750; /* // ğŸ¨ estilo clÃ­nico */
    }

    @media (max-width: 480px) {
      .floating-reset {
        bottom: calc(102px + env(safe-area-inset-bottom, 0px));
        left: 18px;
        width: 48px;
        height: 48px;
      }
    }

    .message {
      display: flex;
      animation: messageReveal 0.6s var(--transition-soft) forwards;
      opacity: 0;
    }

    .message,
    .message-bubble,
    .options-container {
      max-width: 100%;
      overflow-wrap: break-word;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message.assistant {
      justify-content: flex-start;
          flex-direction: column;
    align-items: flex-start;
    }

    .message-bubble {
      max-width: 100%;
      padding: 18px 22px;
      border-radius: var(--radius-lg);
      font-size: 17px;
      line-height: 1.75;
      letter-spacing: 0.01em;
      backdrop-filter: blur(8px); /* // ğŸ¨ estilo clÃ­nico */
      border: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      transition: border-color 0.4s ease, background 0.6s ease, color 0.6s ease;
      white-space: pre-line;
      position: relative;
    }

    .message-bubble.is-typing::after {

    }

    @keyframes caretBlink {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }

    .message-bubble:hover {
      transform: none;
      box-shadow: none;
    }

    .message.assistant .message-bubble {
      background: rgba(255, 255, 255, 0.96); /* // ğŸ¨ estilo clÃ­nico */
      color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 12px 24px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
    }

    .message.user .message-bubble {
      background: rgba(214, 230, 195, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      color: #24304a; /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(201, 221, 182, 0.8); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 12px 24px rgba(31, 42, 68, 0.1); /* // ğŸ¨ estilo clÃ­nico */
    }

    .summary-card {
      align-self: flex-start;
      width: min(640px, 100%);
      padding: 20px 22px;
      border-radius: 22px;
      background: rgba(255, 255, 255, 0.96);
      border: 1px solid rgba(229, 231, 235, 0.9);
      box-shadow: 0 14px 30px rgba(31, 42, 68, 0.12);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .summary-card-label {
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--color-muted);
    }

    .summary-card-title {
      font-family: var(--font-display);
      font-size: 18px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--color-ink);
    }

    .summary-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .summary-section-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--color-muted);
    }

    .summary-section-text {
      font-size: 15px;
      color: var(--color-ink);
      line-height: 1.6;
    }

    .summary-disclaimer {
      margin-top: 18px;
      font-size: 12px;
      color: var(--color-muted);
      line-height: 1.6;
    }

    body[data-theme="light"] .summary-card {
      background: rgba(255, 255, 255, 0.98);
      border-color: rgba(229, 231, 235, 0.9);
      box-shadow: 0 16px 34px rgba(31, 42, 68, 0.12);
    }

    .clinical-question-block {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .clinical-question-intro {
      font-size: 0.82em;
      opacity: 0.65;
      letter-spacing: 0.02em;
    }

    .clinical-question-text {
      font-weight: 500;
      font-size: 1.02em; /* // ğŸ¨ estilo clÃ­nico */
      color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
    }

    .clinical-question-item {
      font-weight: 500;
      margin-top: 6px;
    }

    .clinical-question-item:first-child {
      margin-top: 0;
    }

    body[data-theme="light"] .clinical-question-block {
      border-top-color: rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
    }

    body[data-theme="light"] .message.assistant .message-bubble {
      background: rgba(255, 255, 255, 0.96); /* // ğŸ¨ estilo clÃ­nico */
      color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 16px 32px rgba(31, 42, 68, 0.1); /* // ğŸ¨ estilo clÃ­nico */
    }

    body[data-theme="light"] .message.user .message-bubble {
      background: rgba(214, 230, 195, 0.92); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(201, 221, 182, 0.8); /* // ğŸ¨ estilo clÃ­nico */
      color: #24304a; /* // ğŸ¨ estilo clÃ­nico */
    }

    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 20px;
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      border: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 14px 28px rgba(31, 42, 68, 0.1); /* // ğŸ¨ estilo clÃ­nico */
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9fbf8a; /* // ğŸ¨ estilo clÃ­nico */
      animation: typing 1.3s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
      30% { transform: translateY(-6px); opacity: 1; }
    }

    .options-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 16px;
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .options-container.pending-display {
      opacity: 0;
      transform: translateY(8px);
      pointer-events: none;
    }

    .options-container.initial-options {
      position: relative;
    }

    .options-container.follow-up-options {
      width: 100%;
      margin-left: 0;
      margin-right: 0;
      transform: none;
      transition: opacity 0.25s ease-out;
    }

    .message.assistant .options-container.follow-up-options {
      margin-top: 18px;
    }

    .options-container.follow-up-options.is-hidden {
      opacity: 0;
      pointer-events: none;
    }

    .option-button {
      padding: 12px 20px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.96); /* // ğŸ¨ estilo clÃ­nico */
      color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
      border: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      font-size: 14px;
      letter-spacing: 0.02em;
      text-transform: none;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(31, 42, 68, 0.08); /* // ğŸ¨ estilo clÃ­nico */
      transition: transform 0.18s ease, background 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease;
    }

    .option-button:hover {
      transform: translateY(-2px);
      background: rgba(214, 230, 195, 0.35); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(201, 221, 182, 0.85); /* // ğŸ¨ estilo clÃ­nico */
      color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 14px 26px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
    }

    .option-button.toggle-button {
      flex: 0 0 auto;
      color: #6b7a6a; /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(201, 221, 182, 0.8); /* // ğŸ¨ estilo clÃ­nico */
    }

    body[data-theme="light"] .option-button.toggle-button {
      color: #6b7a6a; /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(201, 221, 182, 0.6); /* // ğŸ¨ estilo clÃ­nico */
    }

    body[data-theme="light"] .option-button {
      background: rgba(255, 255, 255, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
    }

    body[data-theme="light"] .option-button:hover {
      background: rgba(201, 221, 182, 0.35); /* // ğŸ¨ estilo clÃ­nico */
      color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 18px 34px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
    }

    .input-container {
      padding: 24px 26px;
      padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
      display: flex;
      gap: 16px;
      align-items: center;
      background: rgba(251, 250, 245, 0.95); /* // ğŸ¨ estilo clÃ­nico */
      border-top: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      backdrop-filter: blur(12px); /* // ğŸ¨ estilo clÃ­nico */
      transition: background 0.8s ease, border-color 0.6s ease;
      flex-shrink: 0;
    }



    .input-wrapper {
      flex: 1;
      position: relative;
    }

    .message-input {
      width: 100%;
      padding: 16px 22px;
      border-radius: 999px;
      border: 1px solid rgba(229, 231, 235, 0.6); /* // ğŸ¨ estilo clÃ­nico */
      background: rgba(255, 255, 255, 0.98); /* // ğŸ¨ estilo clÃ­nico */
      color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
      font-size: 16px;
      letter-spacing: 0.02em;
      outline: none;
      opacity: 0.88;
      transition: border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }

    .message-input::placeholder {
      color: #8b94a6; /* // ğŸ¨ estilo clÃ­nico */
    }

    .message-input:not(:placeholder-shown) {
      opacity: 1;
      border-color: rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
    }

    .message-input:focus {
      border-color: rgba(201, 221, 182, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      background: rgba(255, 255, 255, 1); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 0 0 6px rgba(201, 221, 182, 0.25); /* // ğŸ¨ estilo clÃ­nico */
      opacity: 1;
    }

    body[data-theme="light"] .message-input {
      background: rgba(255, 255, 255, 0.98); /* // ğŸ¨ estilo clÃ­nico */
      border: 1px solid rgba(229, 231, 235, 0.6); /* // ğŸ¨ estilo clÃ­nico */
      color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
    }

    .send-button {
      width: 52px;
      height: 52px;
      border-radius: 20px;
      border: 1px solid rgba(201, 221, 182, 0.8); /* // ğŸ¨ estilo clÃ­nico */
      background: rgba(214, 230, 195, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      color: #30423c; /* // ğŸ¨ estilo clÃ­nico */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.35s var(--transition-soft), background 0.6s ease, border-color 0.4s ease, box-shadow 0.6s ease, color 0.4s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .send-button:hover {
      transform: translateY(-3px);
    }

    .send-button {
      background: linear-gradient(135deg, rgba(214, 230, 195, 0.95), rgba(201, 221, 182, 0.95)); /* // ğŸ¨ estilo clÃ­nico */
      border: 1px solid rgba(201, 221, 182, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      color: #30423c; /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 22px 44px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
    }

    .send-button:hover {
      background: linear-gradient(135deg, rgba(214, 230, 195, 1), rgba(201, 221, 182, 1)); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(201, 221, 182, 1); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 26px 52px rgba(31, 42, 68, 0.16); /* // ğŸ¨ estilo clÃ­nico */
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    body[data-theme="light"] .send-button {
      border-color: rgba(201, 221, 182, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      background: rgba(214, 230, 195, 0.95); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 18px 36px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
    }

    body[data-theme="light"] .send-button {
      color: #30423c; /* // ğŸ¨ estilo clÃ­nico */
      background: rgba(214, 230, 195, 0.95); /* // ğŸ¨ estilo clÃ­nico */
      border-color: rgba(201, 221, 182, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 22px 42px rgba(31, 42, 68, 0.12); /* // ğŸ¨ estilo clÃ­nico */
    }

    .icon svg,
    .header-portrait svg {
      display: block;
    }

    .welcome-screen {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
      padding: 26px 24px;
      gap: 12px;
      align-self: flex-start;
      width: min(520px, 92%);
      margin-top: auto;
      margin-bottom: 22px;
      background: rgba(255, 255, 255, 0.96); /* // ğŸ¨ estilo clÃ­nico */
      border-radius: 24px;
      border: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
      box-shadow: 0 16px 34px rgba(31, 42, 68, 0.1); /* // ğŸ¨ estilo clÃ­nico */
      animation: firstTurnIn 0.2s ease-out;
    }

.welcome-icon {
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: transparent !important;
  box-shadow: none !important;
}

    .welcome-title {
      font-family: var(--font-body);
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.01em;
      text-transform: none;
    }

    .welcome-subtitle {
      max-width: 420px;
      color: var(--color-muted); /* // ğŸ¨ estilo clÃ­nico */
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-line;
    }

    .welcome-disclaimer {
      max-width: 420px;
      color: var(--color-muted-dark); /* // ğŸ¨ estilo clÃ­nico */
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-line;
    }

    .welcome-screen .options-container {
      margin-top: 10px;
      gap: 12px;
    }

    body[data-theme="light"] .welcome-subtitle {
      color: var(--color-muted); /* // ğŸ¨ estilo clÃ­nico */
    }

    body[data-theme="light"] .welcome-disclaimer {
      color: var(--color-muted-dark); /* // ğŸ¨ estilo clÃ­nico */
    }


    @media (max-width: 360px) {
      .header {
        padding: 14px 14px 16px;
        min-height: 96px;
      }

      .header-portrait {
        width: 68px;
        height: 68px;
        border-radius: 22px;
      }

      .header-title {
        font-size: 16px;
        letter-spacing: 0.16em;
      }

      .header-actions {
        gap: 4px;
        padding: 6px 6px;
      }

      .icon-button {
        width: 30px;
        height: 30px;
      }


      .messages-container {
        padding: 20px 18px;
      }

      .message-bubble {
        max-width: 90%;
        padding: 16px 18px;
        font-size: 16px;
      }

      .input-container {
        padding: 20px;
      }

      .message-input {
        padding: 14px 20px;
      }

      .send-button {
        width: 48px;
        height: 48px;
      }
    }

    @media (min-width: 768px) and (max-width: 1024px) {
      .chat-container {
        max-width: 620px;
        height: 86vh;
      }
    }

















    @keyframes messageReveal {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(18px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes firstTurnIn {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      body,
      .chat-container,
      .message,
      .message-bubble,
      .option-button,
      .send-button,
      .floating-reset,
      .floating-reset svg {
        transition: none !important;
        animation: none !important;
      }
    }
    
    @supports (height: 100dvh) {
  .chat-container {
    height: calc(100vh - 48px);
    background-color: #fbfaf5; /* // ğŸ¨ estilo clÃ­nico */
  }
}

html, body {
  background-color: #fbfaf5; /* // ğŸ¨ estilo clÃ­nico */
  overscroll-behavior-y: contain; /* evita parpadeo blanco al hacer scroll */
}

@media (max-width: 768px) {
  body {
    background-color: #fbfaf5; /* // ğŸ¨ estilo clÃ­nico */
  }
}

.header-titles {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: center;
  gap: 6px;
}

.header-subtitle {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: clamp(13px, 1.8vw, 15px);
  opacity: 0.9;
  font-family: var(--font-display);
  letter-spacing: 0.06em;
  color: var(--color-muted); /* // ğŸ¨ estilo clÃ­nico */
}

.header-subtitle .flag {
  font-size: 16px;
}

.header-tagline {
  font-size: clamp(11px, 1.6vw, 13px);
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: rgba(31, 42, 68, 0.6); /* // ğŸ¨ estilo clÃ­nico */
  font-family: var(--font-body);
}

body[data-theme="light"] .header {
  background: linear-gradient(135deg, #fbfaf5 0%, #f5f6ef 45%, #ffffff 100%); /* // ğŸ¨ estilo clÃ­nico */
  border-bottom-color: rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
}

body[data-theme="light"] .header::before {
  mix-blend-mode: multiply;
  opacity: 0.15;
}

body[data-theme="light"] .header-title {
  color: var(--color-ink); /* // ğŸ¨ estilo clÃ­nico */
}

body[data-theme="light"] .header-subtitle {
  color: var(--color-muted); /* // ğŸ¨ estilo clÃ­nico */
}

body[data-theme="light"] .header-tagline {
  color: rgba(31, 42, 68, 0.6); /* // ğŸ¨ estilo clÃ­nico */
}

.powered-by {
  text-align: center;
  font-size: 10px;
  opacity: 0.6;
  margin-top: -6px;
  margin-bottom: 14px;
  font-family: var(--font-body);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.powered-logo {
  height: 14px;
  opacity: 0.8;
}
body[data-theme="light"] .message-input::placeholder {
  color: #8b94a6; /* // ğŸ¨ estilo clÃ­nico */
}
.input-zone {
  padding-bottom: env(safe-area-inset-bottom, 0px);
  border-top: 1px solid rgba(229, 231, 235, 0.9); /* // ğŸ¨ estilo clÃ­nico */
}

.input-zone .powered-by {
  margin-top: -16px !important;  /* antes era ~14px */
}
.powered-link {
  text-decoration: none;      /* Sin subrayado */
  color: inherit;             /* Usa el mismo color del texto padre */
  font-weight: 400;
}

.powered-link:hover {
  opacity: 0.85;              /* Un pequeÃ±o efecto suave al pasar el mouse */
}

@media (max-width: 768px) {
  .chat-container {
    height: 100dvh!important;
    min-height: 100dvh!important;
  }
}

html,
body {
  width: 100%;
  overflow-x: hidden;
}
@media (max-width: 767px) {

  .options-container.initial-options {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }

  .options-container.initial-options .option-button {
    width: 100%;
    text-align: center;
    padding: 14px 18px;
    font-size: 14px;
    white-space: normal;
    line-height: 1.4;
  }

}

  
  </style>
  <base target="_blank">
</head>
<body>
  <div class="desktop-shell">
    <aside aria-hidden="true">
      <div class="hero-panel-content">
        <div class="hero-panel-heading">
          <h2 class="hero-panel-title">APRAT.CL</h2>
          <div class="header-actions">
            <button type="button" class="icon-button" data-theme-toggle aria-label="Cambiar tema">
              <span class="icon theme-icon"></span>
            </button>
          </div>
        </div>
        <p class="hero-panel-subtitle">
       Habla con un mÃ©dico general para entender sÃ­ntomas, cuidados y seÃ±ales de alarma con calma y claridad.
        </p>
      </div>
      <div class="hero-panel-portrait">
        <img
          src="prat.png"
          alt="Retrato de un mÃ©dico general"
        />
      </div>
      <p class="hero-panel-caption">
        â€œEstoy aquÃ­ para orientarte con calma y claridad sobre tu salud.â€
      </p>
    </aside>

    <div class="chat-container">
<header class="header hero-card">
  <div class="header-content">
    <span class="header-portrait" id="headerIcon">
      <img
        src="prat.png"
        alt="Avatar de un mÃ©dico general"
      />
    </span>

    <div class="header-titles">
      <h1 class="header-title">
        <span class="header-title-text">DR. PRAT</span>
      </h1>

      <div class="header-subtitle">
        <span class="subtitle-text">MÃ©dico general</span>
        <span class="flag">ğŸ©º</span>
      </div>

      <div class="header-tagline">OrientaciÃ³n, calma y cuidado</div>
    </div>
  </div>

  <div class="header-actions">
    <button type="button" class="icon-button" data-theme-toggle aria-label="Cambiar tema">
      <span class="icon theme-icon"></span>
    </button>

  </div>
</header>

    <main class="messages-container" id="messages">
      <div class="chat-menu-wrapper" id="chatMenuWrapper">
        <button
          type="button"
          class="chat-menu-button"
          id="chatMenuButton"
          aria-label="Abrir opciones del chat"
          aria-expanded="false"
        >
          â‹¯
        </button>
        <div class="chat-menu" id="chatMenu" role="menu" aria-hidden="true">
          <button type="button" class="chat-menu-item" id="chatResetOption" role="menuitem">
            <span aria-hidden="true">â†º</span>
            <span>Reiniciar chat</span>
          </button>
          <p class="chat-menu-note">La conversaciÃ³n se guarda solo en este navegador.</p>
        </div>
      </div>
    </main>

    <button type="button" id="resetChatBtn" class="floating-reset" aria-label="Reiniciar la conversaciÃ³n" style="display:none">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="lucide lucide-refresh-ccw-icon lucide-refresh-ccw"
      >
        <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
        <path d="M3 3v5h5" />
        <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" />
        <path d="M16 16h5v5" />
      </svg>
    </button>

<div class="input-zone">
  <form class="input-container" id="form">
    <div class="input-wrapper">
      <input
        type="text"
        id="input"
        class="message-input"
        placeholder="Describe tu sÃ­ntomaâ€¦"
        autocomplete="off"
      />
    </div>

    <button type="submit" class="send-button" id="sendButton">
      <span class="icon" id="sendIcon"></span>
    </button>
  </form>

<div class="powered-by">
  <a href="https://tomos.io" target="_blank" class="powered-link">
    Hecho por Tomos.io
  </a>
</div>


</div>


    </div>
  </div>

  <script type="module">
    import { createIcons, icons } from "https://cdn.jsdelivr.net/npm/lucide@latest/+esm";

    const TEXT = {
      htmlLang: "es",
      title: "Consulta mÃ©dica Â· Asistente de salud",
      headerTitle: "Dr. Prat",
      headerSubtitle: "MÃ©dico general",
      placeholder: "Describe tu sÃ­ntomaâ€¦",
      responsePlaceholder: "Escribe tu respuesta aquÃ­â€¦",
      themeToggle: {
        toLight: "Volver al modo claro",
        toDark: "Activar el modo oscuro",
      },
      welcome: {
        title: "CuÃ©ntame quÃ© sÃ­ntoma o molestia tienes.",
        subtitle:
          "Puedo ayudarte a orientarte y decidir\n" +
          "cuÃ¡ndo es importante consultar a un mÃ©dico.",
        disclaimer: "No reemplazo una evaluaciÃ³n mÃ©dica.",
      },
      initialQuestion: "",
      initialOptions: [
        {
          label: "Tengo un sÃ­ntoma o molestia",
          message: "Tengo un sÃ­ntoma o molestia y quiero orientaciÃ³n mÃ©dica.",
        },
        {
          label: "Estoy preocupado por alguien cercano",
          message: "Estoy preocupado por un problema de salud de alguien cercano.",
        },
        {
          label: "Quiero saber si debo consultar",
          message: "Quiero saber si es necesario consultar a un mÃ©dico.",
        },
        {
          label: "Quiero prepararme para una consulta mÃ©dica",
          message: "Quiero prepararme para una consulta mÃ©dica.",
        },
      ],
      errorMessages: {
        network:
          "Lo siento, hubo un problema al conectar con el servidor. IntÃ©ntalo de nuevo.",
        fetch: "No pude recuperar la respuesta en este momento.",
      },
    };

    const THEME_STORAGE_KEY = "theme-preference";
    const CHAT_STORAGE_KEY = "med-chat-history";
    const API_URL = "https://hotel-chat-proxy.vercel.app/api/med";

    let initialOptionsShown = false;
    let messages = [];
    let storedMessages = [];
    let isTyping = false;
    let summaryShown = false;
    let summaryCard = null;
    let pendingSummaryTrigger = false;
    let pendingSummaryData = null;
    let phase = "apertura";
    let clinicalState = {
      fever: null,
      pain: null,
      duration: null,
      location: null,
    };
    let sentClinicalState = {
      fever: null,
      pain: null,
      duration: null,
      location: null,
    };
    const conversationState = { // MODIFICADO
      symptomProvided: false, // MODIFICADO
      durationProvided: false, // MODIFICADO
      feverProvided: false, // MODIFICADO
      medicationAsked: false, // MODIFICADO
      medicationAnswered: false, // MODIFICADO
      orientationGiven: false, // MODIFICADO
      userHasNoMoreQuestions: false, // MODIFICADO
      conversationClosed: false, // MODIFICADO
    }; // MODIFICADO
    let questionHistory = { // MODIFICADO
      symptomAsked: false, // MODIFICADO
      durationAsked: false, // MODIFICADO
      locationAsked: false, // MODIFICADO
      abdominalPainAsked: false, // MODIFICADO
      fluidsAsked: false, // MODIFICADO
      feverAsked: false, // MODIFICADO
      medicationAsked: false, // MODIFICADO
    }; // MODIFICADO
    let clinicalIntroShown = false; // MODIFICADO

    let messagesContainer;
    let form;
    let input;
    let sendButton;
    let sendIcon;
    let headerIcon;
    let themeToggleButtons = [];
    let headerTitle;
    let resetChatButton;
    let chatMenuWrapper;
    let chatMenuButton;
    let chatMenu;
    let chatResetOption;
    document.addEventListener("DOMContentLoaded", () => {
      createIcons({ icons });
      initializeApp();
    });

    function initializeApp() {
      headerTitle = document.querySelector(".header-title");
      themeToggleButtons = Array.from(document.querySelectorAll("[data-theme-toggle]"));
      messagesContainer = document.getElementById("messages");
      form = document.getElementById("form");
      input = document.getElementById("input");
      sendButton = document.getElementById("sendButton");
      sendIcon = document.getElementById("sendIcon");
      headerIcon = document.getElementById("headerIcon");
      resetChatButton = document.getElementById("resetChatBtn");
      chatMenuWrapper = document.getElementById("chatMenuWrapper");
      chatMenuButton = document.getElementById("chatMenuButton");
      chatMenu = document.getElementById("chatMenu");
      chatResetOption = document.getElementById("chatResetOption");

      renderIcon(sendIcon, "send", { width: 20, height: 20, strokeWidth: 1.6 });

      applyLanguageSettings();
      initializeTheme();
      setupThemeToggle();

      const restored = restoreChatFromStorage();
      if (!restored) {
        startChatExperience();
      }

      if (form) {
        form.addEventListener("submit", (event) => {
          event.preventDefault();
          const text = input?.value?.trim();
          if (!text || isTyping) return;
          input.value = "";
          sendMessage(text);
        });
      }

      if (input) {
        input.addEventListener("keypress", (event) => {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            form?.dispatchEvent(new Event("submit"));
          }
        });
      }

      if (resetChatButton) {
        resetChatButton.addEventListener("click", handleChatReset);
      }

      if (chatMenuButton) {
        chatMenuButton.addEventListener("click", (event) => {
          event.stopPropagation();
          toggleChatMenu();
        });
      }

      if (chatResetOption) {
        chatResetOption.addEventListener("click", (event) => {
          event.stopPropagation();
          closeChatMenu();
          handleChatReset();
        });
      }

      document.addEventListener("click", (event) => {
        if (chatMenuWrapper && !chatMenuWrapper.contains(event.target)) {
          closeChatMenu();
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeChatMenu();
        }
      });
    }

    function applyLanguageSettings() {
      document.documentElement.setAttribute("lang", TEXT.htmlLang);
      document.title = TEXT.title;
      if (headerTitle) headerTitle.textContent = TEXT.headerTitle;
      if (input) input.placeholder = TEXT.placeholder;

      const welcomeTitle = document.querySelector(".welcome-title");
      if (welcomeTitle) welcomeTitle.textContent = TEXT.welcome.title;
      const welcomeSubtitle = document.querySelector(".welcome-subtitle");
      if (welcomeSubtitle) welcomeSubtitle.textContent = TEXT.welcome.subtitle;
      const welcomeDisclaimer = document.querySelector(".welcome-disclaimer");
      if (welcomeDisclaimer) welcomeDisclaimer.textContent = TEXT.welcome.disclaimer;

      applyTheme(getCurrentTheme(), { persist: false });
    }

    function getCurrentTheme() {
      return document.body.getAttribute("data-theme") === "light" ? "light" : "dark";
    }

    function applyTheme(theme, { persist = true } = {}) {
      const normalized = theme === "dark" ? "dark" : "light";
      document.body.setAttribute("data-theme", normalized);
      if (persist) {
        try {
          localStorage.setItem(THEME_STORAGE_KEY, normalized);
        } catch (error) {}
      }
      const iconName = normalized === "dark" ? "sun" : "moon";
      const label = normalized === "dark" ? TEXT.themeToggle.toLight : TEXT.themeToggle.toDark;
      themeToggleButtons.forEach((button) => {
        const iconTarget = button.querySelector(".theme-icon");
        renderIcon(iconTarget, iconName, { width: 22, height: 22, strokeWidth: 1.6 });
        button.setAttribute("aria-label", label);
        button.setAttribute("title", label);
      });
    }

    function initializeTheme() {
      try {
        const stored = localStorage.getItem(THEME_STORAGE_KEY);
        if (stored === "dark" || stored === "light") {
          applyTheme(stored, { persist: false });
          return;
        }
      } catch (error) {}
      applyTheme("dark", { persist: false });
    }

    function setupThemeToggle() {
      if (!themeToggleButtons.length) return;
      themeToggleButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const current = getCurrentTheme();
          const next = current === "dark" ? "light" : "dark";
          applyTheme(next);
        });
      });
    }

    function toggleChatMenu() {
      if (!chatMenuWrapper || !chatMenuButton || !chatMenu) return;
      const isOpen = chatMenuWrapper.classList.toggle("is-open");
      chatMenuButton.setAttribute("aria-expanded", String(isOpen));
      chatMenu.setAttribute("aria-hidden", String(!isOpen));
    }

    function closeChatMenu() {
      if (!chatMenuWrapper || !chatMenuButton || !chatMenu) return;
      chatMenuWrapper.classList.remove("is-open");
      chatMenuButton.setAttribute("aria-expanded", "false");
      chatMenu.setAttribute("aria-hidden", "true");
    }

    function persistStoredMessages() {
      try {
        localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(storedMessages));
      } catch (error) {}
    }

    function loadStoredMessages() {
      try {
        const raw = localStorage.getItem(CHAT_STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed
          .filter((item) => item && typeof item.content === "string" && typeof item.role === "string")
          .map((item) => ({ role: item.role, content: item.content }));
      } catch (error) {
        return [];
      }
    }

    function buildApiMessagesFromStored(history) {
      return history.filter((message, index) => {
        if (message.role !== "assistant") return true;
        if (index === 0 && message.content === TEXT.initialQuestion) return false;
        if (message.content === TEXT.errorMessages.network) return false;
        if (message.content === TEXT.errorMessages.fetch) return false;
        return true;
      });
    }

    function restoreChatFromStorage() {
      storedMessages = loadStoredMessages();
      if (!storedMessages.length) return false;
      messages = buildApiMessagesFromStored(storedMessages);
      isTyping = false;
      initialOptionsShown = true;
      rebuildConversationStateFromHistory(); // MODIFICADO
      rebuildClinicalStateFromHistory();
      phase = storedMessages.length ? "entrevista" : "apertura";
      if (conversationState.orientationGiven) {
        phase = "orientacion";
      }
      if (messagesContainer) {
        resetMessagesContainer();
        storedMessages.forEach((message) => {
          addMessage(message.role, message.content, { animate: false });
        });
        scrollMessagesToBottom();
      }
      if (sendButton) {
        sendButton.disabled = false;
      }
      return true;
    }

    function resetMessagesContainer() {
      if (!messagesContainer) return;
      const menu = chatMenuWrapper;
      if (menu && menu.parentElement === messagesContainer) {
        menu.remove();
      }
      messagesContainer.innerHTML = "";
      if (menu) {
        messagesContainer.appendChild(menu);
      }
    }

    function renderIcon(element, name, options = {}) {
      if (!element) return;

      element.innerHTML = "";

      const iconSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      iconSvg.setAttribute("width", options.width || 24);
      iconSvg.setAttribute("height", options.height || 24);
      iconSvg.setAttribute("viewBox", "0 0 24 24");
      iconSvg.setAttribute("fill", "none");
      iconSvg.setAttribute("stroke", "currentColor");
      iconSvg.setAttribute("stroke-width", options.strokeWidth || 2);
      iconSvg.setAttribute("stroke-linecap", "round");
      iconSvg.setAttribute("stroke-linejoin", "round");

      const iconPaths = {
        anchor: [
          "M12 5a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z",
          "M12 22V8",
          "M5 12H2a10 10 0 0 0 20 0h-3",
          "M5 12l7 -4",
          "M19 12l-7 -4",
        ],
        send: [
          "M22 2L11 13",
          "M22 2l-7 20-4-9-9-4 20-7z",
        ],
        moon: [
          "M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z",
        ],
        sun: [
          "M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0",
          "M3 12h1m8 -9v1m8 8h1m-9 8v1M5.6 5.6l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7",
        ],
      };

      if (iconPaths[name]) {
        iconPaths[name].forEach((pathData) => {
          const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          path.setAttribute("d", pathData);
          iconSvg.appendChild(path);
        });
      }

      element.appendChild(iconSvg);
    }

    function startChatExperience() {
      messages = [];
      storedMessages = [];
      isTyping = false;
      phase = "apertura";
      initialOptionsShown = false;
      summaryShown = false;
      pendingSummaryTrigger = false;
      resetClinicalState();
      resetConversationState(); // MODIFICADO
      clearSummaryCard();
      if (messagesContainer) {
        resetMessagesContainer();
      }
      if (sendButton) {
        sendButton.disabled = false;
      }
      showWelcome();
      renderInitialOptions();
      if (TEXT.initialQuestion) {
        appendMessage("assistant", TEXT.initialQuestion, { includeInApi: false });
      }
      input?.focus();
    }

    function handleChatReset() {
      if (resetChatButton && !resetChatButton.classList.contains("spinning")) {
        resetChatButton.classList.add("spinning");
        setTimeout(() => resetChatButton?.classList.remove("spinning"), 650);
      }

      try {
        localStorage.removeItem(CHAT_STORAGE_KEY);
      } catch (error) {}

      if (messagesContainer) {
        resetMessagesContainer();
        messagesContainer.scrollTop = 0;
      }

      document
        .querySelectorAll(".options-container, .typing-indicator")
        .forEach((node) => {
          const parentMessage = node.closest?.(".message");
          if (parentMessage) {
            parentMessage.remove();
          } else {
            node.remove();
          }
        });

      messages = [];
      storedMessages = [];
      isTyping = false;
      phase = "apertura";
      initialOptionsShown = false;
      summaryShown = false;
      pendingSummaryTrigger = false;
      resetClinicalState();
      resetConversationState(); // MODIFICADO
      clearSummaryCard();
      sendButton?.removeAttribute("disabled");

      showWelcome();
      renderInitialOptions();
      if (TEXT.initialQuestion) {
        appendMessage("assistant", TEXT.initialQuestion, { includeInApi: false });
      }
      messagesContainer?.scrollTo({ top: 0, behavior: "smooth" });
      input?.focus();
    }

function showWelcome() {
  if (!messagesContainer) return;

  const welcomeDiv = document.createElement("div");
  welcomeDiv.className = "welcome-screen";

  const title = document.createElement("h2");
  title.className = "welcome-title";
  title.textContent = TEXT.welcome.title;

  const subtitle = document.createElement("p");
  subtitle.className = "welcome-subtitle";
  subtitle.textContent = TEXT.welcome.subtitle;

  const disclaimer = document.createElement("p");
  disclaimer.className = "welcome-disclaimer";
  disclaimer.textContent = TEXT.welcome.disclaimer;

  welcomeDiv.appendChild(title);
  welcomeDiv.appendChild(subtitle);
  welcomeDiv.appendChild(disclaimer);

  messagesContainer.appendChild(welcomeDiv);
}

function removeInitialOptions() {
  document.querySelectorAll(".options-container.initial-options").forEach((node) => {
    node.remove();
  });
  document.querySelectorAll(".welcome-screen").forEach((node) => {
    node.remove();
  });
}

function renderInitialOptions() {
  if (!messagesContainer || !TEXT.initialOptions.length) return;

  const optionsContainer = document.createElement("div");
  optionsContainer.className = "options-container initial-options";

  TEXT.initialOptions.forEach((option) => {
    const button = document.createElement("button");
    button.type = "button";
    button.className = "option-button";
    button.textContent = option.label;
    button.addEventListener("click", () => {
      const welcomeCard = optionsContainer.closest(".welcome-screen");
      if (welcomeCard) {
        welcomeCard.remove();
      } else {
        optionsContainer.remove();
      }
      sendMessage(option.message);
    });
    optionsContainer.appendChild(button);
  });

  const welcomeCard = document.querySelector(".welcome-screen");
  if (welcomeCard) {
    welcomeCard.appendChild(optionsContainer);
  } else {
    messagesContainer.appendChild(optionsContainer);
  }
  scrollMessagesToBottom();
}

function renderSuggestedQuestions(messageElement, suggestions) { // ğŸ”§ cambio UX mÃ©dico
  // desactivado: UX mÃ©dico pro // ğŸ”§ cambio UX mÃ©dico
  return; // ğŸ”§ cambio UX mÃ©dico
} // ğŸ”§ cambio UX mÃ©dico

function normalizeText(text) {
  return (text || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

function hasAny(text, terms) {
  return terms.some((term) => text.includes(term));
}

function parseDurationFromText(text) {
  const normalized = normalizeText(text);
  const match = normalized.match(
    /\b(\d+|un|una|dos|tres|cuatro|cinco|seis|siete|ocho|nueve|diez)\s+(minutos|minuto|horas|hora|dias|dia|semanas|semana|meses|mes|anos|ano|aÃ±o)\b/
  );
  if (!match) return "";
  return text.trim();
}

function getLastAssistantQuestionText() {
  const assistantText = getLastAssistantMessage();
  const lastQuestionIndex = assistantText.lastIndexOf("?");
  if (lastQuestionIndex === -1) return "";
  const questionStartIndex = assistantText.lastIndexOf("Â¿", lastQuestionIndex);
  if (questionStartIndex === -1) {
    const boundaryIndex = Math.max(
      assistantText.lastIndexOf(".", lastQuestionIndex),
      assistantText.lastIndexOf("\n", lastQuestionIndex),
      assistantText.lastIndexOf("!", lastQuestionIndex),
      assistantText.lastIndexOf(":", lastQuestionIndex)
    );
    return assistantText.slice(boundaryIndex + 1, lastQuestionIndex + 1).trim();
  }
  return assistantText.slice(questionStartIndex, lastQuestionIndex + 1).trim();
}

function cleanLocationCandidate(candidate) {
  if (!candidate) return "";
  const cleaned = candidate
    .replace(/^(en|al|a la altura de)\s+/i, "")
    .replace(/^(el|la|los|las)\s+/i, "")
    .trim()
    .replace(/\s+/g, " ");
  const normalized = normalizeText(cleaned);
  if (!cleaned || normalized.length < 3) return "";
  if (hasAny(normalized, ["aqui", "ahi", "alla", "no se", "nose"])) return "";
  return cleaned;
}

function extractLocationFromText(text) {
  const normalized = normalizeText(text);
  let match = normalized.match(/dolor (?:en|de)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±0-9\s]{2,60})/);
  if (match && match[1]) {
    const cleaned = cleanLocationCandidate(match[1]);
    if (cleaned) return cleaned;
  }

  match = normalized.match(/(?:\ben\b|\bal\b|a la altura de)\s+(?:el|la)?\s*([a-zÃ¡Ã©Ã­Ã³ÃºÃ±0-9\s]{3,60})/);
  if (match && match[1]) {
    const cleaned = cleanLocationCandidate(match[1]);
    if (cleaned) return cleaned;
  }

  match = normalized.match(/\b(arriba|abajo|izquierda|derecha)\b/);
  if (match && match[1]) {
    const cleaned = cleanLocationCandidate(match[1]);
    if (cleaned) return cleaned;
  }

  return "";
}

function updateClinicalStateFromText(text) {
  const normalized = normalizeText(text);
  if (clinicalState.fever === null && hasAny(normalized, ["fiebre", "temperatura"])) {
    clinicalState.fever = !hasAny(normalized, ["sin fiebre", "no tengo fiebre", "no he tenido fiebre"]); // ğŸ” actualiza clinicalState
  }
  if (clinicalState.pain === null && normalized.includes("dolor")) {
    clinicalState.pain = !hasAny(normalized, ["sin dolor", "no tengo dolor", "no siento dolor"]); // ğŸ” actualiza clinicalState
  }
  if (!clinicalState.duration) {
    const duration = parseDurationFromText(text);
    if (duration) {
      clinicalState.duration = duration; // ğŸ” actualiza clinicalState
    }
  }
  if (!clinicalState.location) {
    const location = extractLocationFromText(text);
    if (location) {
      clinicalState.location = location; // ğŸ” actualiza clinicalState
    }
  }
}

function hasMinimumClinicalInfo() {
  return (
    clinicalState.location !== null ||
    clinicalState.duration !== null ||
    clinicalState.fever !== null
  );
}

function isEarlyInterviewPhase() {
  return messages.filter((m) => m.role === "user").length < 2;
}

function hasDiarrheaMentioned() {
  const userMessages = getUserMessagesForSummary();
  return userMessages.some((message) => normalizeText(message).includes("diarrea"));
}

function hasSufficientClinicalInfo() {
  let count = 0;
  if (clinicalState.location) count++;
  if (clinicalState.duration) count++;
  if (clinicalState.fever !== null) count++;
  if (clinicalState.pain !== null || hasDiarrheaMentioned()) count++;
  return count >= 3;
}

function hasAskedKeyQuestion() {
  return (
    questionHistory.durationAsked ||
    questionHistory.abdominalPainAsked ||
    questionHistory.fluidsAsked
  );
}

function nextClinicalQuestion({ requireKeyQuestion = false } = {}) {
  if (clinicalState.duration === null) {
    if (!questionHistory.durationAsked) {
      questionHistory.durationAsked = true;
      return "Â¿Desde cuÃ¡ndo exactamente tienes este sÃ­ntoma?";
    }
  }

  if (clinicalState.location === null) {
    if (!questionHistory.locationAsked) {
      questionHistory.locationAsked = true;
      return "Â¿DÃ³nde sientes la molestia o el dolor?";
    }
  }

  if (clinicalState.fever === null) {
    if (!questionHistory.feverAsked) {
      questionHistory.feverAsked = true;
      return "Â¿Has tenido fiebre?";
    }
  }

  if (clinicalState.pain === null && !hasDiarrheaMentioned()) {
    if (!questionHistory.abdominalPainAsked) {
      questionHistory.abdominalPainAsked = true;
      return "Â¿Tienes dolor abdominal?";
    }
  }

  if (requireKeyQuestion && !questionHistory.abdominalPainAsked) {
    questionHistory.abdominalPainAsked = true;
    return "Â¿Tienes dolor abdominal?";
  }

  if (requireKeyQuestion && !questionHistory.fluidsAsked) {
    questionHistory.fluidsAsked = true;
    return "Â¿Has podido tolerar lÃ­quidos?";
  }

  if (requireKeyQuestion && !questionHistory.durationAsked) {
    questionHistory.durationAsked = true;
    return "Â¿Desde cuÃ¡ndo exactamente tienes este sÃ­ntoma?";
  }

  return null;
}

function interpretBriefResponse(text) {
  const normalized = normalizeText(text);
  const wordCount = normalized.split(/\s+/).filter(Boolean).length;
  const lastQuestion = normalizeText(getLastAssistantQuestionText());
  let interpretedText = "";

  updateClinicalStateFromText(text);

  const locationQuestion = hasAny(lastQuestion, ["donde sientes", "donde es", "ubicacion", "ubicaciÃ³n"]);

  if (!clinicalState.location && locationQuestion && hasAny(normalized, ["en", "lado", "abdomen", "estomago", "estÃ³mago", "costado", "ingle"])) {
    const location = extractLocationFromText(text) || cleanLocationCandidate(text);
    if (location) {
      clinicalState.location = location; // ğŸ” actualiza clinicalState
      interpretedText = `UbicaciÃ³n: ${location}.`;
    }
  }

  if (!interpretedText && wordCount <= 3) {
    if (hasAny(normalized, ["si", "sÃ­", "claro", "ajÃ¡", "aja", "sip"])) {
      if (lastQuestion.includes("fiebre")) {
        clinicalState.fever = true; // ğŸ” actualiza clinicalState
        interpretedText = "Fiebre: sÃ­.";
      } else if (lastQuestion.includes("dolor")) {
        clinicalState.pain = true; // ğŸ” actualiza clinicalState
        interpretedText = "Dolor: sÃ­.";
      }
    }

    if (!interpretedText && hasAny(normalized, ["no", "nop", "para nada"])) {
      if (lastQuestion.includes("fiebre")) {
        clinicalState.fever = false; // ğŸ” actualiza clinicalState
        interpretedText = "Fiebre: no.";
      } else if (lastQuestion.includes("dolor")) {
        clinicalState.pain = false; // ğŸ” actualiza clinicalState
        interpretedText = "Dolor: no.";
      }
    }

    if (!interpretedText && normalized === "fiebre") {
      clinicalState.fever = true; // ğŸ” actualiza clinicalState
      interpretedText = "SÃ­ntoma principal: fiebre.";
    }

    if (!interpretedText && normalized === "dolor") {
      clinicalState.pain = true; // ğŸ” actualiza clinicalState
      interpretedText = "SÃ­ntoma principal: dolor.";
    }

    if (!interpretedText) {
      const duration = parseDurationFromText(text);
      if (duration && (lastQuestion.includes("desde") || lastQuestion.includes("cuando"))) {
        clinicalState.duration = duration; // ğŸ” actualiza clinicalState
        interpretedText = `DuraciÃ³n: ${duration}.`;
      }
    }
  }

  if (interpretedText) {
    return { apiText: interpretedText }; // ğŸ©º interpretaciÃ³n de respuestas breves
  }

  return { apiText: text };
}

function buildClinicalSystemMessage() {
  const parts = [];

  if (clinicalState.fever !== null && clinicalState.fever !== sentClinicalState.fever) {
    parts.push(clinicalState.fever ? "fiebre presente" : "fiebre ausente");
    sentClinicalState.fever = clinicalState.fever;
  }
  if (clinicalState.pain !== null && clinicalState.pain !== sentClinicalState.pain) {
    parts.push(clinicalState.pain ? "dolor presente" : "dolor ausente");
    sentClinicalState.pain = clinicalState.pain;
  }
  if (clinicalState.duration && clinicalState.duration !== sentClinicalState.duration) {
    parts.push(`duraciÃ³n aproximada ${clinicalState.duration}`);
    sentClinicalState.duration = clinicalState.duration;
  }
  if (clinicalState.location && clinicalState.location !== sentClinicalState.location) {
    parts.push(`localizaciÃ³n ${clinicalState.location}`);
    sentClinicalState.location = clinicalState.location;
  }

  if (!parts.length) return "";
  return `Estado clÃ­nico conocido: ${parts.join(", ")}.`;
}

function resetConversationState() { // MODIFICADO
  conversationState.symptomProvided = false; // MODIFICADO
  conversationState.durationProvided = false; // MODIFICADO
  conversationState.feverProvided = false; // MODIFICADO
  conversationState.medicationAsked = false; // MODIFICADO
  conversationState.medicationAnswered = false; // MODIFICADO
  conversationState.orientationGiven = false; // MODIFICADO
  conversationState.userHasNoMoreQuestions = false; // MODIFICADO
  conversationState.conversationClosed = false; // MODIFICADO
  questionHistory = { // MODIFICADO
    symptomAsked: false, // MODIFICADO
    durationAsked: false, // MODIFICADO
    locationAsked: false, // MODIFICADO
    abdominalPainAsked: false, // MODIFICADO
    fluidsAsked: false, // MODIFICADO
    feverAsked: false, // MODIFICADO
    medicationAsked: false, // MODIFICADO
  }; // MODIFICADO
  clinicalIntroShown = false; // MODIFICADO
} // MODIFICADO

function resetClinicalState() {
  clinicalState = {
    fever: null,
    pain: null,
    duration: null,
    location: null,
  };
  sentClinicalState = {
    fever: null,
    pain: null,
    duration: null,
    location: null,
  };
  pendingSummaryData = null;
}

function detectDuration(text) { // MODIFICADO
  const normalized = normalizeText(text); // MODIFICADO
  const patterns = [ // MODIFICADO
    /desde hace\s+\d+\s*(?:minutos|horas|dias|semanas|meses)/, // MODIFICADO
    /desde hace\s+(?:unos|unas|varios|varias)\s+(?:minutos|horas|dias|semanas|meses)/, // MODIFICADO
    /hace\s+\d+\s*(?:minutos|horas|dias|semanas|meses)/, // MODIFICADO
    /hace\s+(?:un|una)\s+(?:dia|semana|mes|aÃ±o)/, // MODIFICADO
    /por\s+\d+\s*(?:minutos|horas|dias|semanas|meses)/, // MODIFICADO
    /desde\s+(?:ayer|anoche|hoy|esta manana|esta tarde|este fin de semana|el\s+\w+)/, // MODIFICADO
    /desde\s+el\s+\w+/, // MODIFICADO
  ]; // MODIFICADO
  return patterns.some((pattern) => pattern.test(normalized)); // MODIFICADO
} // MODIFICADO

function detectFeverMention(text) { // MODIFICADO
  const normalized = normalizeText(text); // MODIFICADO
  if (normalized.includes("fiebre")) return true; // MODIFICADO
  if (normalized.includes("temperatura")) return true; // MODIFICADO
  return false; // MODIFICADO
} // MODIFICADO

function detectMedicationInfo(text) { // MODIFICADO
  const normalized = normalizeText(text); // MODIFICADO
  if (hasAny(normalized, ["ibuprofeno", "paracetamol", "acetaminofen", "naproxeno", "amoxicilina"])) { // MODIFICADO
    return true; // MODIFICADO
  } // MODIFICADO
  if (hasAny(normalized, ["medicamento", "medicina", "pastilla", "jarabe", "gotas"])) { // MODIFICADO
    return true; // MODIFICADO
  } // MODIFICADO
  if (hasAny(normalized, ["no he tomado nada", "no tome nada", "no he tomado medicamento", "no estoy tomando"])) { // MODIFICADO
    return true; // MODIFICADO
  } // MODIFICADO
  return false; // MODIFICADO
} // MODIFICADO

function detectNoMoreQuestions(text) { // MODIFICADO
  const normalized = normalizeText(text); // MODIFICADO
  return hasAny(normalized, [ // MODIFICADO
    "no tengo mas preguntas", // MODIFICADO
    "no tengo mas dudas", // MODIFICADO
    "nada mas", // MODIFICADO
    "eso es todo", // MODIFICADO
    "ninguna otra", // MODIFICADO
    "no necesito mas", // MODIFICADO
    "no gracias", // MODIFICADO
  ]); // MODIFICADO
} // MODIFICADO

function updateConversationStateFromUser(text) { // MODIFICADO
  const normalized = normalizeText(text); // MODIFICADO
  if (!conversationState.symptomProvided) { // MODIFICADO
    const symptom = extractSymptomPhrase(text); // MODIFICADO
    if (symptom) { // MODIFICADO
      conversationState.symptomProvided = true; // MODIFICADO
    } // MODIFICADO
  } // MODIFICADO
  if (!conversationState.durationProvided && detectDuration(normalized)) { // MODIFICADO
    conversationState.durationProvided = true; // MODIFICADO
  } // MODIFICADO
  if (!conversationState.feverProvided && detectFeverMention(normalized)) { // MODIFICADO
    conversationState.feverProvided = true; // MODIFICADO
  } // MODIFICADO
  if (!conversationState.medicationAnswered && detectMedicationInfo(normalized)) { // MODIFICADO
    conversationState.medicationAnswered = true; // MODIFICADO
    conversationState.medicationAsked = true; // MODIFICADO
  } // MODIFICADO
  if (detectNoMoreQuestions(normalized)) { // MODIFICADO
    conversationState.userHasNoMoreQuestions = true; // MODIFICADO
  } // MODIFICADO
  if (conversationState.userHasNoMoreQuestions &&
      conversationState.symptomProvided &&
      conversationState.durationProvided &&
      conversationState.orientationGiven) { // MODIFICADO
    conversationState.conversationClosed = true; // MODIFICADO
  } // MODIFICADO
} // MODIFICADO

function rebuildConversationStateFromHistory() { // MODIFICADO
  resetConversationState(); // MODIFICADO
  storedMessages
    .filter((message) => message.role === "user") // MODIFICADO
    .forEach((message) => { // MODIFICADO
      updateConversationStateFromUser(message.content || ""); // MODIFICADO
    }); // MODIFICADO
} // MODIFICADO

function rebuildClinicalStateFromHistory() {
  resetClinicalState();
  storedMessages
    .filter((message) => message.role === "user")
    .forEach((message) => {
      updateClinicalStateFromText(message.content || "");
    });
}

function isClosingUserMessage(text) {
  const t = text.toLowerCase().trim();
  return [
    "gracias",
    "ok",
    "listo",
    "eso es todo",
    "perfecto",
    "vale",
    "entendido",
    "no gracias"
  ].includes(t);
}

function isAssistantClosingMessage(text) {
  const normalized = normalizeText(text);
  return hasAny(normalized, [
    "orientacion esta clara",
    "orientacion queda clara",
    "con esto queda claro",
    "con esta informacion es suficiente",
    "es suficiente por ahora",
  ]);
}

function isRecommendationMessage(text) {
  const normalized = normalizeText(text);
  return hasAny(normalized, [
    "consultar",
    "consulta",
    "acudir",
    "urgencia",
    "emergencia",
    "guardia",
    "observar",
    "observa",
    "vigilar",
    "monitorear",
  ]);
}

function messageHasQuestion(text) {
  return /[?Â¿]/.test(text || "");
}

function getLastAssistantMessage() {
  for (let i = storedMessages.length - 1; i >= 0; i -= 1) {
    const message = storedMessages[i];
    if (message.role === "assistant") {
      return message.content || "";
    }
  }
  return "";
}

function getLastUserMessageText() {
  for (let i = storedMessages.length - 1; i >= 0; i -= 1) {
    const message = storedMessages[i];
    if (message.role === "user") {
      return message.content || "";
    }
  }
  return "";
}

function hasOpenUserQuestion() {
  const lastUser = getLastUserMessageText();
  return messageHasQuestion(lastUser);
}

function shouldShowSummary(text) {
  const assistantMessage = text || "";
  if (!assistantMessage) return false;
  if (messageHasQuestion(assistantMessage)) return false;
  if (hasOpenUserQuestion()) return false;
  if (!isRecommendationMessage(assistantMessage)) return false;
  return pendingSummaryTrigger || isAssistantClosingMessage(assistantMessage) || isRecommendationMessage(assistantMessage);
}

function clearSummaryCard() {
  if (summaryCard) {
    summaryCard.remove();
    summaryCard = null;
  }
  summaryShown = false;
  pendingSummaryData = null;
}

function getLastUserMessage({ includeClosing = false } = {}) {
  for (let i = storedMessages.length - 1; i >= 0; i -= 1) {
    const message = storedMessages[i];
    if (message.role !== "user") continue;
    if (!includeClosing && isClosingUserMessage(message.content)) continue;
    return message.content;
  }
  return "";
}

function shortenText(text, maxLength = 160) {
  const cleaned = text.replace(/\s+/g, " ").trim();
  if (cleaned.length <= maxLength) return cleaned;
  return `${cleaned.slice(0, maxLength).trim()}â€¦`;
}

function getUserMessagesForSummary() {
  return storedMessages
    .filter((message) => message.role === "user")
    .map((message) => message.content)
    .filter((content) => content && !isClosingUserMessage(content));
}

function extractAllSymptoms(text) {
  const lower = normalizeText(text);
  const patterns = [
    { pattern: /dolor de garganta/, label: "dolor de garganta" },
    { pattern: /dolor de cabeza|cefalea/, label: "dolor de cabeza" },
    { pattern: /dolor abdominal|dolor de estomago|dolor estomacal/, label: "dolor abdominal" },
    { pattern: /dolor en el pecho|dolor de pecho/, label: "dolor en el pecho" },
    { pattern: /dolor de espalda/, label: "dolor de espalda" },
    { pattern: /dolor de oido|dolor de oreja|dolor de oidos|dolor de orejas/, label: "dolor de oÃ­do" },
    { pattern: /fiebre/, label: "fiebre" },
    { pattern: /tos/, label: "tos" },
    { pattern: /congestion|nariz tapada|secrecion nasal|goteo nasal/, label: "congestiÃ³n nasal" },
    { pattern: /nausea|nauseas/, label: "nÃ¡useas" },
    { pattern: /vomito|vomitos|v[oÃ³]mito|v[oÃ³]mitos/, label: "vÃ³mitos" },
    { pattern: /diarrea/, label: "diarrea" },
    { pattern: /mareo|vertigo/, label: "mareo" },
    { pattern: /fatiga|cansancio/, label: "cansancio" },
    { pattern: /dificultad para respirar|falta de aire|disnea/, label: "dificultad para respirar" },
    { pattern: /ardor al orinar|dolor al orinar/, label: "ardor al orinar" },
    { pattern: /picazon|picor/, label: "picazÃ³n" },
    { pattern: /erupcion|sarpullido/, label: "erupciÃ³n en la piel" },
    { pattern: /hinchazon|inflamacion/, label: "hinchazÃ³n" },
  ];

  const matches = [];
  patterns.forEach((entry) => {
    if (entry.pattern.test(lower)) {
      matches.push(entry.label);
    }
  });

  const painMatch = lower.match(/dolor (?:de|en)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]{2,40})/);
  if (painMatch) {
    const location = painMatch[1].trim().replace(/\s+/g, " ");
    if (location) {
      matches.push(`dolor de ${location}`);
    }
  }

  return Array.from(new Set(matches));
}

function extractSymptomPhrase(text) {
  const matches = extractAllSymptoms(text);
  return matches[0] || "";
}

function extractRelevantDetails(messages) {
  const details = [];
  const durationPatterns = [
    /(desde hace\s+[a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±\s]+?)([.,;]|$)/i,
    /(hace\s+[a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±\s]+?)([.,;]|$)/i,
    /(por\s+[a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±\s]+?)([.,;]|$)/i,
  ];
  const negationPatterns = [
    /(sin\s+[a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)([.,;]|$)/i,
    /(no\s+(?:tengo|he tenido|presento|hay)\s+[a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)([.,;]|$)/i,
  ];

  messages.forEach((message) => {
    durationPatterns.forEach((pattern) => {
      if (details.length >= 2) return;
      const match = message.match(pattern);
      if (match && match[1]) {
        const detail = shortenText(match[1], 80);
        if (!details.includes(detail)) {
          details.push(detail);
        }
      }
    });

    negationPatterns.forEach((pattern) => {
      if (details.length >= 2) return;
      const match = message.match(pattern);
      if (match && match[1]) {
        const detail = shortenText(match[1], 80);
        if (!details.includes(detail)) {
          details.push(detail);
        }
      }
    });
  });

  return details.slice(0, 2);
}

function extractOrientationText(text, keywords) {
  const sentences = text
    .split(/(?<=[.!?])\s+/)
    .map((sentence) => sentence.trim())
    .filter(Boolean);
  for (const sentence of sentences) {
    const normalized = normalizeText(sentence);
    if (keywords.some((keyword) => normalized.includes(keyword))) {
      return sentence;
    }
  }
  return "";
}

function extractDurationPhrase(messages) { // MODIFICADO
  const durationPatterns = [ // MODIFICADO
    /(desde hace\s+[a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±\s]+?)([.,;]|$)/i, // MODIFICADO
    /(hace\s+[a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±\s]+?)([.,;]|$)/i, // MODIFICADO
    /(por\s+[a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±\s]+?)([.,;]|$)/i, // MODIFICADO
    /(desde\s+(?:ayer|anoche|hoy|esta maÃ±ana|esta tarde|este fin de semana|el\s+\w+))([.,;]|$)/i, // MODIFICADO
  ]; // MODIFICADO
  for (const message of messages) { // MODIFICADO
    for (const pattern of durationPatterns) { // MODIFICADO
      const match = message.match(pattern); // MODIFICADO
      if (match && match[1]) { // MODIFICADO
        return shortenText(match[1], 80); // MODIFICADO
      } // MODIFICADO
    } // MODIFICADO
  } // MODIFICADO
  return ""; // MODIFICADO
} // MODIFICADO

function buildProbableCauses(symptom) { // MODIFICADO
  const normalized = normalizeText(symptom); // MODIFICADO
  const map = [ // MODIFICADO
    { match: ["dolor de garganta"], causes: ["irritaciÃ³n de garganta", "faringitis viral", "resfriado comÃºn"] }, // MODIFICADO
    { match: ["dolor de cabeza", "cefalea"], causes: ["tensiÃ³n muscular", "migraÃ±a leve", "deshidrataciÃ³n"] }, // MODIFICADO
    { match: ["dolor abdominal"], causes: ["indigestiÃ³n", "gastroenteritis leve", "gastritis"] }, // MODIFICADO
    { match: ["tos"], causes: ["infecciÃ³n viral", "irritaciÃ³n de vÃ­as respiratorias", "goteo nasal"] }, // MODIFICADO
    { match: ["congestion nasal"], causes: ["resfriado", "rinitis alÃ©rgica", "sinusitis leve"] }, // MODIFICADO
    { match: ["fiebre"], causes: ["infecciÃ³n viral", "resfriado", "proceso inflamatorio"] }, // MODIFICADO
    { match: ["diarrea"], causes: ["gastroenteritis", "intolerancia alimentaria", "irritaciÃ³n intestinal"] }, // MODIFICADO
    { match: ["nauseas", "nausea", "vomitos", "vomito"], causes: ["gastroenteritis", "indigestiÃ³n", "virus estomacal"] }, // MODIFICADO
    { match: ["mareo"], causes: ["baja de presiÃ³n", "deshidrataciÃ³n", "vÃ©rtigo leve"] }, // MODIFICADO
    { match: ["dolor en el pecho", "dolor de pecho"], causes: ["irritaciÃ³n muscular", "estrÃ©s", "reflujo"] }, // MODIFICADO
  ]; // MODIFICADO
  for (const entry of map) { // MODIFICADO
    if (entry.match.some((term) => normalized.includes(term))) { // MODIFICADO
      return entry.causes; // MODIFICADO
    } // MODIFICADO
  } // MODIFICADO
  return ["cuadro viral leve", "irritaciÃ³n local", "tensiÃ³n fÃ­sica"]; // MODIFICADO
} // MODIFICADO

function detectAlertSigns(messages) { // MODIFICADO
  const joined = normalizeText(messages.join(" ")); // MODIFICADO
  if (hasAny(joined, ["dificultad para respirar", "falta de aire", "dolor en el pecho", "desmayo", "confusion"])) { // MODIFICADO
    return "Si presentas dificultad para respirar, dolor en el pecho, confusiÃ³n o desmayo, es mejor consultar de urgencia."; // MODIFICADO
  } // MODIFICADO
  if (joined.match(/\b39\b|\b40\b|fiebre alta|muy alta/)) { // MODIFICADO
    return "Si la fiebre es alta o no cede, conviene consultar para una evaluaciÃ³n mÃ©dica."; // MODIFICADO
  } // MODIFICADO
  if (hasAny(joined, ["sangrado", "vomitos persistentes", "dolor intenso"])) { // MODIFICADO
    return "Si aparece sangrado, vÃ³mitos persistentes o dolor muy intenso, consulta cuanto antes."; // MODIFICADO
  } // MODIFICADO
  return ""; // MODIFICADO
} // MODIFICADO

function extractSummaryFromAssistant(text) {
  const marker = "RESUMEN_CLINICO:";
  const markerIndex = text.indexOf(marker);
  if (markerIndex === -1) {
    return { cleanText: text, summary: null };
  }

  const cleanText = text.slice(0, markerIndex).trimEnd();
  const block = text.slice(markerIndex + marker.length).trim();
  const lines = block
    .split("\n")
    .map((line) => line.trim())
    .filter(Boolean);

  const summary = {
    resumen: "",
    probable: "",
    cuidados: "",
    alerta: "",
  };

  lines.forEach((line) => {
    const match = line.match(/^(Resumen|Probable|Cuidados|Alerta):\s*(.+)$/i);
    if (match) {
      const key = normalizeText(match[1]);
      summary[key] = match[2];
    }
  });

  if (!summary.resumen || !summary.probable || !summary.cuidados || !summary.alerta) {
    return { cleanText: cleanText || text, summary: null };
  }

  return { cleanText, summary };
}

function softenAssistantText(text) {
  if (!text) return "";
  const replacements = [
    { pattern: /sugiere que tienes/gi, replacement: "lo mÃ¡s frecuente en este escenario es" },
    { pattern: /indica que tienes/gi, replacement: "una posibilidad probable es" },
    { pattern: /podr[iÃ­]as estar enfrentando/gi, replacement: "esto podrÃ­a corresponder a" },
  ];
  return replacements.reduce(
    (acc, { pattern, replacement }) => acc.replace(pattern, replacement),
    text
  );
}

function enforceOrientationResponse(text) {
  const sentences = (text || "")
    .split(/(?<=[.!?])\s+/)
    .map((sentence) => sentence.trim())
    .filter(Boolean);
  const withoutQuestions = sentences.filter((sentence) => !messageHasQuestion(sentence));
  if (!withoutQuestions.length) {
    return "Con la informaciÃ³n disponible, la orientaciÃ³n general es observar la evoluciÃ³n y consultar si hay seÃ±ales de alarma.";
  }
  return withoutQuestions.join(" ");
}

function capitalizeSentence(text) {
  if (!text) return "";
  return text.charAt(0).toUpperCase() + text.slice(1);
}

function buildSummarySentence(symptoms, duration) {
  if (!symptoms.length) {
    return duration
      ? `SÃ­ntomas referidos recientemente, ${duration}.`
      : "SÃ­ntomas referidos recientemente.";
  }

  if (symptoms.length === 1) {
    const base = `${capitalizeSentence(symptoms[0])}`;
    return duration ? `${base}, ${duration}.` : `${base}.`;
  }

  const [first, ...rest] = symptoms;
  const restText = rest.length ? rest.join(", ").replace(/, ([^,]*)$/, " y $1") : "";
  const base = `${capitalizeSentence(first)} asociada a ${restText}`;
  return duration ? `${base}, ${duration}.` : `${base}.`;
}

function buildLocalSummaryData() {
  const userMessages = getUserMessagesForSummary();
  const symptom = getSymptomFromHistory();
  const duration = extractDurationPhrase(userMessages);
  const symptoms = Array.from(
    new Set(userMessages.flatMap((message) => extractAllSymptoms(message)))
  );
  const resumen = buildSummarySentence(symptoms, duration);

  const probable = symptom
    ? buildProbableCauses(symptom)[0]
    : "posible causa digestiva / inflamatoria segÃºn lo descrito";

  return {
    resumen,
    probable,
    cuidados: "hidrataciÃ³n, reposo, observar evoluciÃ³n",
    alerta:
      "dolor intenso, fiebre persistente, vÃ³mitos repetidos, decaimiento marcado, sangre, dificultad para respirar",
  };
}

function renderSummaryCard(summary) {
  if (!messagesContainer || summaryShown || !summary) return;

  const card = document.createElement("section");
  card.className = "summary-card";

  const sections = [
    { title: "Resumen", text: summary.resumen },
    { title: "Probable", text: summary.probable },
    { title: "Cuidados", text: summary.cuidados },
    { title: "Alerta", text: summary.alerta },
  ];

  sections.forEach((section) => { // ğŸ§¾ renderiza tarjeta de resumen
    const block = document.createElement("div");
    block.className = "summary-section";

    const heading = document.createElement("div");
    heading.className = "summary-section-title";
    heading.textContent = section.title;

    const paragraph = document.createElement("p");
    paragraph.className = "summary-section-text";
    paragraph.textContent = section.text;

    block.appendChild(heading);
    block.appendChild(paragraph);
    card.appendChild(block);
  });

  const disclaimer = document.createElement("p");
  disclaimer.className = "summary-disclaimer";
  disclaimer.textContent =
    "Este resumen es solo orientativo y no reemplaza una evaluaciÃ³n mÃ©dica.";
  card.appendChild(disclaimer);

  summaryCard = card;
  summaryShown = true;
  messagesContainer.appendChild(card);
  scrollMessagesToBottom();
}

function maybeRenderSummaryCard(assistantText = "") {
  if (summaryShown || !pendingSummaryData) return;
  if (pendingSummaryTrigger || !messageHasQuestion(assistantText)) {
    renderSummaryCard(pendingSummaryData);
    pendingSummaryData = null;
    pendingSummaryTrigger = false;
  }
}


    function scrollMessagesToBottom() {
      if (!messagesContainer) return;
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    const typingSettings = {
      minDelay: 12,
      maxDelay: 45,
    };

    function buildClinicalQuestionBlock() {
      const block = document.createElement("div");
      block.className = "clinical-question-block";

      const intro = document.createElement("div");
      intro.className = "clinical-question-intro";
      intro.textContent = clinicalIntroShown ? "" : "Para orientarme mejor:"; // MODIFICADO
      if (!clinicalIntroShown) { // MODIFICADO
        clinicalIntroShown = true; // MODIFICADO
      } // MODIFICADO

      const question = document.createElement("div");
      question.className = "clinical-question-text";

      block.appendChild(intro);
      block.appendChild(question);

      return { block, question };
    }

    function splitQuestionText(text) {
      const trimmed = text.trimEnd();
      if (!trimmed.endsWith("?")) return null;
      const questionEnd = trimmed.lastIndexOf("?");
      const questionStartFromOpening = trimmed.lastIndexOf("Â¿", questionEnd);
      const boundaryChars = ["\n", ".", "!", ":", ";"];
      let questionStart = questionStartFromOpening;

      if (questionStart === -1) {
        const boundaryIndex = boundaryChars
          .map((char) => trimmed.lastIndexOf(char, questionEnd - 1))
          .reduce((max, current) => Math.max(max, current), -1);
        questionStart = boundaryIndex >= 0 ? boundaryIndex + 1 : 0;
      }

      const leading = text.slice(0, questionStart).trimEnd();
      const question = trimmed.slice(questionStart).trim();
      if (!question) return null;
      return { leading, question };
    }

    function splitTrailingQuestions(text, maxQuestions = 2) {
      const trimmed = (text || "").trimEnd();
      if (!trimmed.endsWith("?")) return null;

      const lines = trimmed
        .split("\n")
        .map((l) => l.trim())
        .filter(Boolean);

      if (!lines.length) return null;

      // Tomar desde el final hasta maxQuestions lÃ­neas que terminen en '?'
      const questions = [];
      let cutIndex = lines.length;

      for (let i = lines.length - 1; i >= 0; i--) {
        const l = lines[i];
        if (l.endsWith("?")) {
          questions.unshift(l);
          cutIndex = i;
          if (questions.length >= maxQuestions) break;
        } else {
          // si ya empezamos a capturar preguntas y aparece una lÃ­nea sin '?', paramos
          if (questions.length) break;
        }
      }

      // Si solo hay 1 pregunta, reutiliza splitQuestionText para separar bien el texto+pregunta
      if (questions.length <= 1) {
        const single = splitQuestionText(trimmed);
        if (!single) return null;
        return { leading: single.leading, questions: [single.question] };
      }

      const leading = lines.slice(0, cutIndex).join("\n").trimEnd();
      return { leading, questions };
    }


    function findLastMeaningfulNode(root) {
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT);
      let lastNode = null;
      while (walker.nextNode()) {
        const node = walker.currentNode;
        if (node.nodeType === Node.TEXT_NODE && node.textContent?.trim()) {
          lastNode = node;
        } else if (node.nodeType === Node.ELEMENT_NODE && node.textContent?.trim()) {
          lastNode = node;
        }
      }
      return lastNode;
    }

    function applyClinicalQuestionStyle(wrapper) {
      if (!wrapper) return;
      const fullText = wrapper.textContent || "";
      if (!fullText.trim().endsWith("?")) return;

      if (!wrapper.innerHTML.includes("<")) {
        const split = splitTrailingQuestions(fullText, 2);
        if (!split) return;

        wrapper.textContent = "";
        if (split.leading) {
          wrapper.appendChild(document.createTextNode(split.leading));
        }

        const { block, question } = buildClinicalQuestionBlock();

        // Render 1â€“2 preguntas al final
        split.questions.forEach((q) => {
          const item = document.createElement("div");
          item.className = "clinical-question-item";
          item.textContent = q;
          question.appendChild(item);
        });

        wrapper.appendChild(block);
        return;
      }

      const lastNode = findLastMeaningfulNode(wrapper);
      if (!lastNode) return;

      if (lastNode.nodeType === Node.ELEMENT_NODE) {
        const elementText = lastNode.textContent || "";
        if (!elementText.trim().endsWith("?")) return;
        const { block, question } = buildClinicalQuestionBlock();
        lastNode.remove();
        question.appendChild(lastNode);
        wrapper.appendChild(block);
        return;
      }

      const split = splitQuestionText(lastNode.textContent || "");
      if (!split) return;
      lastNode.textContent = split.leading;
      const { block, question } = buildClinicalQuestionBlock();
      question.textContent = split.question;
      wrapper.appendChild(block);
    }

    function animateAssistantMessage(bubble, content) {
      const wrapper = document.createElement("div");
      wrapper.textContent = content || "";
      applyClinicalQuestionStyle(wrapper);
      const nodesQueue = Array.from(wrapper.childNodes);
      bubble.innerHTML = "";
      bubble.classList.add("is-typing");
      bubble.dataset.typingComplete = "false";

      const finishTyping = () => {
        bubble.classList.remove("is-typing");
        bubble.dataset.typingComplete = "true";
        scrollMessagesToBottom();
        bubble.dispatchEvent(
          new CustomEvent("typingcomplete", { bubbles: true })
        );
      };

      const processNextNode = () => {
        if (!nodesQueue.length) {
          finishTyping();
          return;
        }

        const node = nodesQueue.shift();
        typeNode(node, bubble, processNextNode);
      };

      const typeNode = (node, target, done) => {
        if (!node) {
          done();
          return;
        }

        if (node.nodeType === Node.TEXT_NODE) {
          typeText(node.textContent || "", target, done);
          return;
        }

        if (node.nodeType === Node.ELEMENT_NODE) {
          const clone = node.cloneNode(false);
          target.appendChild(clone);
          const childNodes = Array.from(node.childNodes);

          const processChild = () => {
            if (!childNodes.length) {
              done();
              return;
            }
            const child = childNodes.shift();
            typeNode(child, clone, processChild);
          };

          processChild();
          return;
        }

        done();
      };

      const typeText = (text, target, done) => {
        if (!text) {
          done();
          return;
        }

        const textNode = document.createTextNode("");
        target.appendChild(textNode);
        let index = 0;

        const step = () => {
          textNode.textContent += text.charAt(index);
          index += 1;
          scrollMessagesToBottom();

          if (index < text.length) {
            const dynamicDelay = Math.min(
              typingSettings.maxDelay,
              Math.max(typingSettings.minDelay, 160 / Math.log2(text.length + 3))
            );
            setTimeout(step, dynamicDelay);
          } else {
            done();
          }
        };

        step();
      };

      processNextNode();
    }

    function addMessage(role, content, { animate = true } = {}) {
      if (!messagesContainer) return null;

      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${role}`;

      const bubble = document.createElement("div");
      bubble.className = "message-bubble";

      if (role === "assistant") {
        if (animate) {
          animateAssistantMessage(bubble, content);
        } else {
          bubble.textContent = content;
        }
      } else {
        bubble.textContent = content;
      }

      messageDiv.appendChild(bubble);
      messagesContainer.appendChild(messageDiv);
      scrollMessagesToBottom();

      if (role === "assistant" && !initialOptionsShown) {
        initialOptionsShown = true;
        const welcome = document.querySelector(".welcome-screen");
        if (welcome) {
          welcome.remove();
        }
      }
      return messageDiv;
    }

    function addAssistantMessage(content, options = {}) {
      return appendMessage("assistant", content, { includeInApi: false, ...options });
    }

    function recordMessage(
      role,
      content,
      { includeInApi = true, includeInStorage = true } = {}
    ) {
      if (includeInStorage) {
        storedMessages.push({ role, content });
        persistStoredMessages();
      }
      if (includeInApi) {
        messages.push({ role, content });
      }
    }

    function appendMessage(
      role,
      content,
      { animate = true, includeInApi = true, includeInStorage = true } = {}
    ) {
      const messageElement = addMessage(role, content, { animate });
      recordMessage(role, content, { includeInApi, includeInStorage });
      return messageElement;
    }

    function showTypingIndicator() {
      if (!messagesContainer) return null;
      const typingDiv = document.createElement("div");
      typingDiv.className = "message assistant";

      const typingIndicator = document.createElement("div");
      typingIndicator.className = "typing-indicator";

      for (let i = 0; i < 3; i++) {
        const dot = document.createElement("div");
        dot.className = "typing-dot";
        typingIndicator.appendChild(dot);
      }

      typingDiv.appendChild(typingIndicator);
      messagesContainer.appendChild(typingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      return typingDiv;
    }

function getSymptomFromHistory() { // MODIFICADO
  const userMessages = getUserMessagesForSummary(); // MODIFICADO
  let symptom = ""; // MODIFICADO
  userMessages.forEach((message) => { // MODIFICADO
    if (symptom) return; // MODIFICADO
    symptom = extractSymptomPhrase(message); // MODIFICADO
  }); // MODIFICADO
  return symptom; // MODIFICADO
} // MODIFICADO

function buildOrientationMessage() { // MODIFICADO
  const symptom = getSymptomFromHistory() || "los sÃ­ntomas que describes"; // MODIFICADO
  const duration = extractDurationPhrase(getUserMessagesForSummary()); // MODIFICADO
  const probable = buildProbableCauses(symptom).slice(0, 2); // MODIFICADO
  const durationText = duration ? `, ${duration}` : ""; // MODIFICADO
  return (
    `Con lo que me cuentas sobre ${symptom}${durationText}, es posible que sea algo frecuente como ${probable.join(" o ")}. ` +
    "No puedo hacer un diagnÃ³stico, pero en general se puede observar la evoluciÃ³n y consultar si los sÃ­ntomas empeoran, " +
    "si aparecen seÃ±ales de alarma o si no mejoran en los prÃ³ximos dÃ­as."
  ); // MODIFICADO
} // MODIFICADO

function buildAssistantReply() { // MODIFICADO
  if (conversationState.conversationClosed) { // MODIFICADO
    return "Con lo que me has contado, ya tengo una orientaciÃ³n bastante clara. Si aparece algo nuevo o empeora, consulta."; // MODIFICADO
  } // MODIFICADO

  if (!conversationState.symptomProvided) { // MODIFICADO
    if (!questionHistory.symptomAsked) { // MODIFICADO
      questionHistory.symptomAsked = true; // MODIFICADO
      return (
        "Gracias por contÃ¡rmelo. Voy a hacerte unas preguntas breves para orientarte mejor. " +
        "Â¿CuÃ¡l es el sÃ­ntoma principal que mÃ¡s te preocupa ahora?"
      ); // MODIFICADO
    } // MODIFICADO
    return "Cuando quieras, puedes contarme el sÃ­ntoma principal con tus palabras."; // MODIFICADO
  } // MODIFICADO

  if (!conversationState.durationProvided) { // MODIFICADO
    if (!questionHistory.durationAsked) { // MODIFICADO
      questionHistory.durationAsked = true; // MODIFICADO
      return "Gracias. Â¿Desde cuÃ¡ndo tienes ese sÃ­ntoma?"; // MODIFICADO
    } // MODIFICADO
    return "Ese dato de tiempo me ayuda a orientar mejor el caso."; // MODIFICADO
  } // MODIFICADO

  if (!conversationState.feverProvided) { // MODIFICADO
    if (!questionHistory.feverAsked) { // MODIFICADO
      questionHistory.feverAsked = true; // MODIFICADO
      return "Â¿Has tenido fiebre?"; // MODIFICADO
    } // MODIFICADO
    return "TambiÃ©n es Ãºtil saber si hubo fiebre."; // MODIFICADO
  } // MODIFICADO

  if (!conversationState.medicationAnswered) { // MODIFICADO
    if (!questionHistory.medicationAsked) { // MODIFICADO
      questionHistory.medicationAsked = true; // MODIFICADO
      return "Â¿Has tomado algÃºn medicamento o remedio hasta ahora?"; // MODIFICADO
    } // MODIFICADO
    return "Si tomaste algÃºn medicamento, ese detalle puede ser Ãºtil."; // MODIFICADO
  } // MODIFICADO

  if (!conversationState.orientationGiven) { // MODIFICADO
    conversationState.orientationGiven = true; // MODIFICADO
    if (conversationState.userHasNoMoreQuestions &&
        conversationState.symptomProvided &&
        conversationState.durationProvided) { // MODIFICADO
      conversationState.conversationClosed = true; // MODIFICADO
    } // MODIFICADO
    return buildOrientationMessage(); // MODIFICADO
  } // MODIFICADO

  if (conversationState.userHasNoMoreQuestions &&
      conversationState.symptomProvided &&
      conversationState.durationProvided) { // MODIFICADO
    conversationState.conversationClosed = true; // MODIFICADO
    return "Con lo que me has contado, ya tengo una orientaciÃ³n bastante clara. Si aparece algo nuevo o empeora, consulta."; // MODIFICADO
  } // MODIFICADO

  return "Si quieres, puedo aclarar alguna duda concreta sobre lo que sientes."; // MODIFICADO
} // MODIFICADO

async function sendMessage(text) {
  if (isTyping) return;

  const sanitizedText = text.trim();
  if (!sanitizedText) return;

  removeInitialOptions();
  isTyping = true;
  const interpreted = interpretBriefResponse(sanitizedText); // ğŸ©º interpretaciÃ³n de respuestas breves
  appendMessage("user", sanitizedText, { includeInApi: false });
  recordMessage("user", interpreted.apiText, { includeInStorage: false });
  const isClosing = isClosingUserMessage(sanitizedText);
  pendingSummaryTrigger = pendingSummaryTrigger || isClosing;

  const finalizeLocalResponse = () => {
    isTyping = false;
    if (sendButton) {
      sendButton.disabled = false;
    }
    if (input) {
      input.placeholder = TEXT.placeholder;
      input.focus();
    }
  };

  const systemSummary = buildClinicalSystemMessage();
  if (systemSummary) {
    recordMessage("system", systemSummary, { includeInStorage: false }); // ğŸ›°ï¸ envÃ­a mensaje system invisible
  }

  if (phase === "apertura") {
    phase = "entrevista";
  }

  if (phase === "entrevista") {
    const earlyInterview = isEarlyInterviewPhase();
    const sufficientInfo = hasSufficientClinicalInfo();
    const keyQuestionAsked = hasAskedKeyQuestion();
    const requiresInterview = earlyInterview || !sufficientInfo || !keyQuestionAsked;
    if (requiresInterview) {
      const question = nextClinicalQuestion({ requireKeyQuestion: !keyQuestionAsked || earlyInterview });
      const fallbackQuestion = "Â¿Hay algÃºn otro sÃ­ntoma importante que deba saber?";
      addAssistantMessage(question || fallbackQuestion);
      finalizeLocalResponse();
      return;
    }
    phase = "orientacion";
  }

  if (isClosingUserMessage(sanitizedText) && phase === "orientacion" && !summaryShown) {
    phase = "cierre";
    pendingSummaryTrigger = true;
  }

  if (phase === "cierre") {
    if (!summaryShown) {
      addAssistantMessage("Gracias, aquÃ­ tienes el resumen clÃ­nico.");
      pendingSummaryData = buildLocalSummaryData();
      renderSummaryCard(pendingSummaryData);
      pendingSummaryData = null;
    }
    finalizeLocalResponse();
    return;
  }

  if (phase === "orientacion" && conversationState.orientationGiven) {
    finalizeLocalResponse();
    return;
  }

  if (isClosing && summaryShown) {
    appendMessage(
      "assistant",
      "Perfecto. Si aparece algo nuevo o empeora, consulta.",
      { includeInApi: false }
    );
    finalizeLocalResponse();
    return;
  }

  const typingIndicator = showTypingIndicator();
  if (sendButton) {
    sendButton.disabled = true;
  }

  try {
    const response = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages,
        lang: "es",
      }),
    });

    if (!response.ok) {
      throw new Error("Network response was not ok");
    }

    const data = await response.json();
    const reply = data?.answer || TEXT.errorMessages.fetch;
    const summaryExtraction = extractSummaryFromAssistant(reply);
    const assistantText = summaryExtraction.cleanText.trim();
    if (summaryExtraction.summary) {
      pendingSummaryData = summaryExtraction.summary;
    }

    typingIndicator?.remove();
    if (assistantText) {
      const softenedText = softenAssistantText(assistantText);
      const finalText = phase === "orientacion"
        ? enforceOrientationResponse(softenedText)
        : softenedText;
      appendMessage("assistant", finalText);
    } else {
      recordMessage("assistant", assistantText, { includeInStorage: false });
    }
    if (phase === "orientacion") {
      conversationState.orientationGiven = true;
    }
    if (!summaryExtraction.summary && isClosing && !summaryShown) {
      pendingSummaryData = buildLocalSummaryData();
    }
    maybeRenderSummaryCard(assistantText);
  } catch (error) {
    typingIndicator?.remove();
    appendMessage("assistant", TEXT.errorMessages.network, { includeInApi: false });
  } finally {
    isTyping = false;
    if (sendButton) {
      sendButton.disabled = false;
    }
    if (input) {
      input.placeholder = TEXT.placeholder;
      input.focus();
    }
  }
}

  </script>
</body>
</html>
