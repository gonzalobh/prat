<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Decision Clarifier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Aclara decisiones humanas. Entiende la situación, el riesgo y el próximo movimiento." />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f7f6f3;
      color: #111827;
      min-height: 100vh;
    }

    * {
      box-sizing: border-box;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 28px 4px;
      position: relative;
    }

    .app-title {
      font-size: 15px;
      font-weight: 600;
      color: #0f172a;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .menu-button {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: #475569;
    }

    .menu {
      position: absolute;
      right: 28px;
      top: 56px;
      margin-top: 8px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 6px;
      display: none;
      z-index: 5;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }

    .menu.open {
      display: block;
    }

    .menu button {
      background: none;
      color: #0f172a;
      width: 100%;
      text-align: left;
      padding: 8px;
      font-size: 13px;
    }

    .workspace {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(260px, 1.1fr) minmax(320px, 2.9fr);
      grid-template-rows: 1fr;
      gap: 28px;
      padding: 18px 36px 42px;
      min-height: 0;
    }

    .column {
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #ececec;
      padding: 22px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .column-header {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 18px;
    }

    .input-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .input-row {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    textarea {
      width: 100%;
      padding: 16px 18px;
      font-size: 15px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      outline: none;
      resize: none;
      line-height: 1.7;
      min-height: 120px;
      background: #f9fafb;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    textarea:focus {
      border-color: #9ca3af;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.08);
    }

    button {
      padding: 14px 18px;
      border-radius: 12px;
      border: none;
      background: #111827;
      color: #fff;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
      box-shadow: none;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      background: #0f172a;
    }

    button:disabled {
      opacity: 0.65;
      cursor: not-allowed;
      box-shadow: none;
    }

    .column-input {
      grid-row: 1;
      max-height: 1200px;
      overflow: hidden;
      transition: max-height 0.32s cubic-bezier(0.4, 0, 0.2, 1),
        opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
        padding 0.32s cubic-bezier(0.4, 0, 0.2, 1),
        border-width 0.32s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .column-input.is-collapsed {
      max-height: 0;
      opacity: 0;
      padding: 0;
      border-width: 0;
      pointer-events: none;
    }

    .column-input.is-restoring {
      transition: none;
    }

    .messages {
      grid-column: 2;
      grid-row: 1;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-right: 4px;
      transition: margin 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .message {
      padding: 0;
      border-radius: 0;
      line-height: 1.6;
      white-space: pre-wrap;
      background: transparent;
    }

    .message.user {
      display: none;
    }

    .response-shell {
      width: 100%;
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      flex-direction: column;
      gap: 28px;
      padding: 24px 0 36px;
      transition: max-width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .insight-block {
      text-align: center;
      padding: 32px 18px 22px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .insight-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.22em;
      color: #9ca3af;
      font-weight: 600;
    }

    .insight-text {
      font-size: 32px;
      font-weight: 650;
      color: #111827;
      line-height: 1.35;
      max-width: 520px;
      margin: 0 auto;
      transition: max-width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .reasoning-toggle {
      background: transparent;
      border: 1px solid #e5e7eb;
      color: #64748b;
      font-size: 12px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      cursor: pointer;
      align-self: center;
      padding: 10px 14px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease;
    }

    .reasoning-toggle:hover {
      border-color: #cbd5e1;
      background: #f8fafc;
      color: #475569;
    }

    .reasoning-toggle:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.12);
    }

    .reasoning-icon {
      font-size: 14px;
      line-height: 1;
      transition: transform 0.2s ease;
    }

    .reasoning-toggle.is-open .reasoning-icon {
      transform: rotate(180deg);
    }

    .analysis-panel {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.35s ease, opacity 0.35s ease;
      display: flex;
      flex-direction: column;
      gap: 18px;
      border-top: 1px solid #e5e7eb;
      padding: 0 8px;
    }

    .analysis-panel.is-open {
      max-height: 1200px;
      opacity: 1;
      padding-top: 22px;
      padding-bottom: 12px;
    }

    .analysis-user-card {
      font-size: 13px;
      color: #6b7280;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .analysis-user-title {
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 11px;
    }

    .analysis-user-body {
      font-size: 14px;
      line-height: 1.6;
      color: #334155;
      white-space: pre-wrap;
    }

    .analysis-section {
      border-top: 1px solid #e5e7eb;
      padding-top: 14px;
    }

    .analysis-section-title {
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #64748b;
      margin-bottom: 8px;
    }

    .analysis-section-body {
      color: #334155;
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    .options-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
      transition: max-width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .option-card {
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px 18px;
      background: #ffffff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 10px;
      cursor: pointer;
    }

    .option-card:hover {
      border-color: #d1d5db;
      box-shadow: 0 4px 16px rgba(15, 23, 42, 0.06);
    }

    .option-title {
      font-weight: 600;
      font-size: 16px;
      color: #111827;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .option-title-text {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .option-chevron {
      font-size: 18px;
      color: #9ca3af;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    .option-card.is-active .option-chevron {
      transform: rotate(90deg);
      color: #6b7280;
    }

    .option-tradeoff {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.5;
      opacity: 1;
    }

    .option-body {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .option-card.is-active .option-body {
      max-height: 400px;
      opacity: 1;
    }

    .option-text {
      font-size: 14px;
      line-height: 1.7;
      color: #111827;
      white-space: pre-wrap;
    }

    .copy-button {
      align-self: flex-start;
      border: none;
      background: none;
      color: #6b7280;
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      padding: 0;
      cursor: pointer;
      min-width: 96px;
    }

    .option-card:focus-visible {
      outline: none;
      border-color: #94a3b8;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.12);
    }

    .loader-panel {
      display: none;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-radius: 14px;
      border: 1px dashed #d1d5db;
      background: #f9fafb;
      color: #6b7280;
      font-weight: 600;
      font-size: 13px;
      align-self: center;
    }

    .loader-spinner {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid #d1d5db;
      border-top-color: #111827;
      animation: spin 0.9s linear infinite;
    }

    .loader-desktop {
      display: none;
    }

    .loader-mobile {
      display: none;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes fadeCopy {
      0% {
        opacity: 0;
        transform: translateY(4px);
      }
      20% {
        opacity: 1;
        transform: translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateY(-4px);
      }
    }

    @media (max-width: 1023px) {
      .workspace {
        grid-template-columns: 1fr;
        grid-template-rows: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .column {
        border-radius: 16px;
        padding: 18px;
        border: 1px solid #ececec;
      }

      .column-input {
        grid-row: auto;
      }

      .messages {
        grid-column: 1;
        grid-row: auto;
      }

      .response-shell {
        padding: 8px 0 24px;
      }

      .insight-text {
        font-size: 26px;
      }

      textarea {
        min-height: 180px;
      }

      .loader-desktop {
        display: none;
      }

      .loader-mobile.is-active {
        display: flex;
      }
    }

    @media (min-width: 1024px) {
      .loader-desktop.is-active {
        display: flex;
      }

      .workspace:not(.is-reflection-mode) {
        grid-template-columns: minmax(0, 1fr);
      }

      .workspace:not(.is-reflection-mode) .column-input {
        max-width: 740px;
        width: 100%;
        margin: 0 auto;
      }

      .workspace:not(.is-reflection-mode) textarea {
        min-height: 140px;
        padding: 20px 20px;
      }

      .workspace:not(.is-reflection-mode) .messages {
        display: none;
      }

      .workspace.is-reflection-mode .messages {
        width: 100%;
        margin: 0 auto;
        padding-right: 0;
      }

      .workspace.is-reflection-mode .response-shell {
        max-width: 840px;
      }

      .workspace.is-reflection-mode .insight-text {
        max-width: 720px;
      }

      .workspace.is-reflection-mode .options-list {
        width: 100%;
        max-width: 840px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>

<div class="app-shell">
  <div class="top-bar">
    <div class="app-title">Decision Clarifier</div>
    <button class="menu-button" id="menuBtn">⋯</button>
  </div>
  <div class="menu" id="menu">
    <button id="resetBtn">↺ Reiniciar chat</button>
  </div>

  <div class="workspace">
    <section class="column column-input">
      <div class="column-header">Describe la situación</div>
      <form class="input-container" id="form">
        <div class="input-row">
          <textarea id="input" rows="2" placeholder="Describe la situación (o pega el texto/email). Sé concreto." autocomplete="off"></textarea>
          <button type="submit">Obtener claridad</button>
          <div class="loader-panel loader-mobile" id="loaderMobile">
            <span class="loader-spinner" aria-hidden="true"></span>
            <span>Pensando…</span>
          </div>
        </div>
      </form>
    </section>

    <div class="messages" id="messages"></div>
  </div>
</div>

<script>
  const API_URL = "https://hotel-chat-proxy.vercel.app/api/t4";

  const messagesEl = document.getElementById("messages");
  const form = document.getElementById("form");
  const input = document.getElementById("input");
  const menuBtn = document.getElementById("menuBtn");
  const menu = document.getElementById("menu");
  const resetBtn = document.getElementById("resetBtn");
  const workspace = document.querySelector(".workspace");
  const inputColumn = document.querySelector(".column-input");
  const submitButton = form.querySelector("button[type='submit']");
  const loaderMobile = document.getElementById("loaderMobile");

  let messages = [];
  let currentContext = "General";
  let isLoading = false;
  let insightTextEl = null;
  let reasoningToggleEl = null;
  let analysisPanelEl = null;
  let optionsListEl = null;
  let loaderDesktopEl = null;
  let activeOption = null;
  let lastUserText = "";

  const WELCOME =
    "Describe la situación.\n" +
    "Te digo dónde estás parado y 3 movimientos posibles.";

  function addMessage(role, text) {
    const div = document.createElement("div");
    div.className = `message ${role}`;
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function buildUserMessageCard(text) {
    const wrapper = document.createElement("div");
    wrapper.className = "analysis-user-card";

    const title = document.createElement("div");
    title.className = "analysis-user-title";
    title.textContent = "Lo que entendí";

    const body = document.createElement("div");
    body.className = "analysis-user-body";
    body.textContent = text;

    wrapper.appendChild(title);
    wrapper.appendChild(body);

    return wrapper;
  }

  function buildLoaderPanel(type) {
    const loader = document.createElement("div");
    loader.className = `loader-panel ${type}`;
    loader.innerHTML = `
      <span class="loader-spinner" aria-hidden="true"></span>
      <span>Pensando…</span>
    `;
    return loader;
  }

  function cleanInsightHeadline(text) {
    if (!text) return "";
    let cleaned = text
      .replace(/^["“”'«»]+|["“”'«»]+$/g, "")
      .replace(/\s{2,}/g, " ")
      .trim();
    cleaned = cleaned.replace(
      /^(?:["“”'«»]\s*)?(Situaci[oó]n|Situacion|Contexto|Caso)\s*:\s*/i,
      ""
    );
    return cleaned.replace(/\s{2,}/g, " ").trim();
  }

  function extractAnalysisSections(text) {
    try {
      const normalized = text.replace(/\r\n/g, "\n").trim();
      const lecturaIndex = normalized.search(/Lectura r[áa]pida/i);
      const pasandoIndex = normalized.search(/Qu[eé]\s+est[aá]\s+pasando/i);
      const estrategiaIndex = normalized.search(/Estrategia/i);
      if (lecturaIndex === -1 || pasandoIndex === -1 || pasandoIndex <= lecturaIndex) {
        return null;
      }

      const lecturaTitleMatch = normalized.match(/Lectura r[áa]pida/i);
      const pasandoTitleMatch = normalized.match(/Qu[eé]\s+est[aá]\s+pasando/i);
      const estrategiaTitleMatch = normalized.match(/Estrategia/i);
      const lecturaTitleRaw = lecturaTitleMatch ? lecturaTitleMatch[0] : "Lectura rápida";
      const pasandoTitleRaw = pasandoTitleMatch ? pasandoTitleMatch[0] : "Qué está pasando";
      const estrategiaTitleRaw = estrategiaTitleMatch ? estrategiaTitleMatch[0] : "Estrategia";
      let lecturaTitle = lecturaTitleRaw.trim();
      let pasandoTitle = pasandoTitleRaw.trim();
      let estrategiaTitle = estrategiaTitleRaw.trim();
      if (/Lectura r[áa]pida/i.test(lecturaTitle)) {
        lecturaTitle = "En una frase";
      }
      if (/Qu[eé]\s+est[aá]\s+pasando/i.test(pasandoTitle)) {
        pasandoTitle = "Qué hay detrás";
      }
      if (/Estrategia/i.test(estrategiaTitle)) {
        estrategiaTitle = "Cómo moverte ahora";
      }
      const lecturaBody = normalized
        .slice(lecturaIndex + lecturaTitleRaw.length, pasandoIndex)
        .trim()
        .replace(/^[:\-\s]+/, "");
      let pasandoBody = "";
      let estrategiaBody = "";

      if (estrategiaIndex !== -1 && estrategiaIndex > pasandoIndex) {
        pasandoBody = normalized
          .slice(pasandoIndex + pasandoTitleRaw.length, estrategiaIndex)
          .trim()
          .replace(/^[:\-\s]+/, "");
        estrategiaBody = normalized
          .slice(estrategiaIndex + estrategiaTitleRaw.length)
          .trim()
          .replace(/^[:\-\s]+/, "");
      } else {
        pasandoBody = normalized
          .slice(pasandoIndex + pasandoTitleRaw.length)
          .trim()
          .replace(/^[:\-\s]+/, "");
      }

      const sections = [
        { title: lecturaTitle, body: lecturaBody },
        { title: pasandoTitle, body: pasandoBody }
      ];
      if (estrategiaBody) {
        sections.push({ title: estrategiaTitle, body: estrategiaBody });
      }
      return sections;
    } catch (error) {
      console.error(error);
      return null;
    }
  }

  function buildAnalysisSection(section) {
    const sectionEl = document.createElement("div");
    sectionEl.className = "analysis-section";

    const title = document.createElement("div");
    title.className = "analysis-section-title";
    title.textContent = section.title;

    const body = document.createElement("div");
    body.className = "analysis-section-body";
    body.textContent = section.body;

    sectionEl.appendChild(title);
    if (section.body) {
      sectionEl.appendChild(body);
    }

    return sectionEl;
  }

  function extractFirstSentence(text) {
    const cleaned = text.replace(/^[\s:\-–—]+/, "").trim();
    if (!cleaned) return "";
    const match = cleaned.match(/[^.!?]+[.!?]/);
    if (match) {
      return match[0].trim();
    }
    const firstLine = cleaned.split("\n").find(line => line.trim());
    return (firstLine || cleaned).trim();
  }

  function findSectionText(text, startRegex, stopRegexes) {
    const startMatch = text.match(startRegex);
    if (!startMatch) return "";
    const startIndex = text.search(startRegex);
    const start = startIndex + startMatch[0].length;
    let end = text.length;
    stopRegexes.forEach((regex) => {
      const sliceIndex = text.slice(start).search(regex);
      if (sliceIndex !== -1) {
        end = Math.min(end, start + sliceIndex);
      }
    });
    return text.slice(start, end).trim();
  }

  function extractAppleInsight(rawAnalysisText) {
    const fallback =
      "Esta situación no está definida. Eso, en sí mismo, ya es una decisión.";
    try {
      if (!rawAnalysisText) return fallback;
      const normalized = rawAnalysisText.replace(/\r\n/g, "\n").trim();
      if (!normalized) return fallback;
      const lecturaSection = findSectionText(
        normalized,
        /Lectura r[áa]pida/i,
        [/Qu[eé]\s+est[aá]\s+pasando/i, /Estrategia/i, /Opc[ií]ón\s*[A-C]/i]
      );
      if (lecturaSection) {
        const sentence = extractFirstSentence(lecturaSection);
        if (sentence) return sentence;
      }
      const pasandoSection = findSectionText(
        normalized,
        /Qu[eé]\s+est[aá]\s+pasando/i,
        [/Estrategia/i, /Opc[ií]ón\s*[A-C]/i]
      );
      if (pasandoSection) {
        const sentence = extractFirstSentence(pasandoSection);
        if (sentence) return sentence;
      }
      return fallback;
    } catch (error) {
      console.error(error);
      return fallback;
    }
  }

  function extractTradeoffLine(text) {
    const clean = text.replace(/\r\n/g, "\n").trim();
    if (!clean) return "";
    const lines = clean.split("\n").map(line => line.trim()).filter(Boolean);
    if (lines.length > 1) {
      return lines[0].slice(0, 120);
    }
    const sentences = clean.split(/(?<=[.!?])\s+/).filter(Boolean);
    if (sentences.length > 1) {
      return sentences[0].trim().slice(0, 120);
    }
    return "";
  }

  function setActiveOption(label) {
    activeOption = label;
    if (!optionsListEl) return;
    optionsListEl.querySelectorAll(".option-card").forEach(card => {
      card.classList.toggle("is-active", card.dataset.label === label);
      card.setAttribute("aria-expanded", card.dataset.label === label ? "true" : "false");
    });
  }

  function addAssistantResponse(analysisText, options) {
    try {
      if (insightTextEl) {
        insightTextEl.textContent = cleanInsightHeadline(extractAppleInsight(analysisText || ""));
      }
      if (analysisPanelEl) {
        analysisPanelEl.innerHTML = "";
        if (analysisText) {
          analysisPanelEl.appendChild(buildUserMessageCard(lastUserText || ""));
          const sections = extractAnalysisSections(analysisText);
          if (sections) {
            sections.forEach(section => {
              analysisPanelEl.appendChild(buildAnalysisSection(section));
            });
          } else {
            const plain = document.createElement("div");
            plain.className = "analysis-section-body";
            plain.textContent = analysisText;
            analysisPanelEl.appendChild(plain);
          }
        }
      }
      if (reasoningToggleEl) {
        reasoningToggleEl.style.display = analysisText ? "inline-flex" : "none";
      }

      if (!optionsListEl) return;
      optionsListEl.innerHTML = "";
      const optionTitles = {
        A: "Esperar",
        B: "Abrir diálogo",
        C: "Forzar definición"
      };
      options.forEach((option) => {
        const card = document.createElement("div");
        card.className = "option-card";
        card.dataset.label = option.label;
        card.setAttribute("tabindex", "0");
        card.setAttribute("role", "button");
        card.setAttribute("aria-expanded", "false");

        const title = document.createElement("div");
        title.className = "option-title";
        const titleText = document.createElement("div");
        titleText.className = "option-title-text";
        titleText.textContent = `${option.label} — ${optionTitles[option.label] || "Opción"}`;

        const chevron = document.createElement("span");
        chevron.className = "option-chevron";
        chevron.setAttribute("aria-hidden", "true");
        chevron.textContent = "›";

        title.appendChild(titleText);
        title.appendChild(chevron);

        const tradeoff = document.createElement("div");
        tradeoff.className = "option-tradeoff";
        tradeoff.textContent = extractTradeoffLine(option.text);
        if (!tradeoff.textContent) {
          tradeoff.style.display = "none";
        }

        const body = document.createElement("div");
        body.className = "option-body";

        const text = document.createElement("div");
        text.className = "option-text";
        text.textContent = option.text;

        const copyButton = document.createElement("button");
        copyButton.type = "button";
        copyButton.className = "copy-button";
        copyButton.setAttribute("aria-label", "Copiar texto");
        copyButton.textContent = "Copiar texto";

        copyButton.addEventListener("click", async (event) => {
          event.stopPropagation();
          try {
            await navigator.clipboard.writeText(option.text);
            copyButton.textContent = "Copiado ✓";
            setTimeout(() => {
              copyButton.textContent = "Copiar texto";
            }, 1200);
          } catch (error) {
            console.error(error);
          }
        });

        body.appendChild(text);
        body.appendChild(copyButton);
        card.appendChild(title);
        card.appendChild(tradeoff);
        card.appendChild(body);
        card.addEventListener("click", () => {
          setActiveOption(activeOption === option.label ? null : option.label);
        });
        card.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            setActiveOption(activeOption === option.label ? null : option.label);
          }
        });
        optionsListEl.appendChild(card);
      });
      setActiveOption(null);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    } catch (error) {
      console.error(error);
    }
  }

  function parseResponse(answer) {
    try {
      if (!answer) return { analysis: "", options: [] };
      const normalized = answer.replace(/\r\n/g, "\n");
      const optionRegex = (label) =>
        new RegExp(
          `Opc[ií]ón\\s*${label}\\s*(?:\\([^\\)]*\\))?\\s*:\\s*([\\s\\S]*?)(?=Opc[ií]ón\\s*[A-C]\\s*(?:\\(|:)|$)`,
          "i"
        );
      const options = ["A", "B", "C"]
        .map((label) => {
          const match = normalized.match(optionRegex(label));
          return match ? { label, text: match[1].trim() } : null;
        })
        .filter(Boolean);
      const firstOptionIndex = normalized.search(/Opc[ií]ón\s*[A-C]/i);
      const analysisContent =
        firstOptionIndex !== -1 ? normalized.slice(0, firstOptionIndex).trim() : normalized.trim();
      return { analysis: analysisContent, options };
    } catch (error) {
      console.error(error);
      return { analysis: answer || "", options: [] };
    }
  }

  function setLoading(state) {
    isLoading = state;
    submitButton.disabled = state;
    submitButton.textContent = state ? "Pensando…" : "Obtener claridad";
    loaderMobile.classList.toggle("is-active", state);
    if (loaderDesktopEl) {
      loaderDesktopEl.classList.toggle("is-active", state);
    }
  }

  function loadChat() {
    messages = [];
    addMessage("assistant", WELCOME);
  }

  async function sendMessage(text) {
    // 1. Congelar layout (sin animación)
    inputColumn.classList.add("is-restoring");

    // 2. Activar modo reflexión sin transición visual
    workspace.classList.add("is-reflection-mode");

    // 3. Forzar reflow
    inputColumn.offsetHeight;

    // 4. Colapsar suavemente (solo fade + vertical)
    inputColumn.classList.remove("is-restoring");
    inputColumn.classList.add("is-collapsed");
    lastUserText = text;
    const payloadLines = [`[Contexto: ${currentContext}]`];
    payloadLines.push(text);
    const payloadFinal = payloadLines.join("\n");

    messagesEl.innerHTML = "";
    messages = [{ role: "user", content: payloadFinal }];

    const assistantShell = document.createElement("div");
    assistantShell.className = "response-shell";

    const insightBlock = document.createElement("div");
    insightBlock.className = "insight-block";

    const insightLabel = document.createElement("div");
    insightLabel.className = "insight-label";
    insightLabel.textContent = "INSIGHT";

    insightTextEl = document.createElement("div");
    insightTextEl.className = "insight-text";
    insightTextEl.textContent = "…";

    reasoningToggleEl = document.createElement("button");
    reasoningToggleEl.type = "button";
    reasoningToggleEl.className = "reasoning-toggle";
    reasoningToggleEl.setAttribute("aria-expanded", "false");

    const reasoningText = document.createElement("span");
    reasoningText.className = "reasoning-text";
    reasoningText.textContent = "Ver razonamiento completo";

    const reasoningIcon = document.createElement("span");
    reasoningIcon.className = "reasoning-icon";
    reasoningIcon.setAttribute("aria-hidden", "true");
    reasoningIcon.textContent = "⌄";

    reasoningToggleEl.appendChild(reasoningText);
    reasoningToggleEl.appendChild(reasoningIcon);

    insightBlock.appendChild(insightLabel);
    insightBlock.appendChild(insightTextEl);
    insightBlock.appendChild(reasoningToggleEl);

    analysisPanelEl = document.createElement("div");
    analysisPanelEl.className = "analysis-panel";

    loaderDesktopEl = buildLoaderPanel("loader-desktop");

    optionsListEl = document.createElement("div");
    optionsListEl.className = "options-list";

    assistantShell.appendChild(insightBlock);
    assistantShell.appendChild(loaderDesktopEl);
    assistantShell.appendChild(analysisPanelEl);
    assistantShell.appendChild(optionsListEl);
    messagesEl.appendChild(assistantShell);

    reasoningToggleEl.addEventListener("click", () => {
      const isOpen = analysisPanelEl.classList.toggle("is-open");
      reasoningToggleEl.classList.toggle("is-open", isOpen);
      reasoningToggleEl.setAttribute("aria-expanded", isOpen ? "true" : "false");
      reasoningText.textContent = isOpen ? "Ocultar razonamiento" : "Ver razonamiento completo";
      reasoningIcon.textContent = isOpen ? "⌃" : "⌄";
    });

    setLoading(true);
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages })
      });

      const rawText = await res.text();
      let answerText = rawText;
      try {
        const data = JSON.parse(rawText);
        if (data && typeof data.answer === "string") {
          answerText = data.answer;
        }
      } catch (error) {
        console.error(error);
      }

      const parsed = parseResponse(answerText || "");
      addAssistantResponse(parsed.analysis, parsed.options);
      messages.push({ role: "assistant", content: answerText });
    } catch (error) {
      console.error(error);
    } finally {
      setLoading(false);
    }
  }

  form.addEventListener("submit", e => {
    e.preventDefault();
    if (isLoading) return;
    const text = input.value.trim();
    if (!text) return;
    input.value = "";
    input.style.height = "";
    sendMessage(text);
  });

  function autoGrowTextarea() {
    const styles = getComputedStyle(input);
    const lineHeight = parseFloat(styles.lineHeight) || 24;
    const maxHeight = lineHeight * 8;
    input.style.height = "auto";
    input.style.height = `${Math.min(input.scrollHeight, maxHeight)}px`;
  }

  input.addEventListener("input", autoGrowTextarea);
  input.addEventListener("keydown", event => {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      form.requestSubmit();
    }
  });
  autoGrowTextarea();

  menuBtn.onclick = () => menu.classList.toggle("open");
  resetBtn.onclick = () => {
    messages = [];
    messagesEl.innerHTML = "";
    addMessage("assistant", WELCOME);
    currentContext = "General";
    inputColumn.classList.add("is-restoring");
    inputColumn.classList.remove("is-collapsed");
    inputColumn.offsetHeight;
    inputColumn.classList.remove("is-restoring");
    workspace.classList.remove("is-reflection-mode");
    menu.classList.remove("open");
    input.focus();
  };

  loadChat();
</script>

</body>
</html>
