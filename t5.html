<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Decision Clarifier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Aclara decisiones humanas. Entiende la situaci√≥n, el riesgo y el pr√≥ximo movimiento." />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f7f6f3;
      color: #111827;
      min-height: 100vh;
    }

    * {
      box-sizing: border-box;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 28px 4px;
      position: relative;
    }

    .app-title {
      font-size: 15px;
      font-weight: 600;
      color: #0f172a;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .menu-button {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: #475569;
    }

    .menu {
      position: absolute;
      right: 28px;
      top: 56px;
      margin-top: 8px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 6px;
      display: none;
      z-index: 5;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }

    .menu.open {
      display: block;
    }

    .menu button {
      background: none;
      color: #0f172a;
      width: 100%;
      text-align: left;
      padding: 8px;
      font-size: 13px;
    }

    .workspace {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
      padding: 24px 16px 42px;
    }

    .column {
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #ececec;
      padding: 22px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .column-header {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 18px;
    }

    .input-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .context-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .context-button {
      padding: 7px 13px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      color: #111827;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
    }

    .context-button:hover {
      border-color: #cbd5f5;
      color: #111827;
    }

    .context-button.active {
      background: #111827;
      color: #fff;
      border-color: #111827;
    }

    .input-row {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .profile-row {
      background: #f9fafb;
      border-radius: 14px;
      border: 1px solid #ececec;
      padding: 14px;
    }

    .profile-row.is-collapsed {
      display: none;
    }

    .advanced-toggle {
      background: none;
      border: none;
      color: #6b7280;
      font-size: 12px;
      font-weight: 600;
      padding: 0;
      cursor: pointer;
      text-align: left;
    }

    .profile-label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
    }

    select {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 13px;
      color: #111827;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    select:focus {
      border-color: #9ca3af;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.08);
    }

    textarea {
      width: 100%;
      padding: 16px 18px;
      font-size: 15px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      outline: none;
      resize: none;
      line-height: 1.7;
      min-height: 220px;
      background: #f9fafb;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    textarea:focus {
      border-color: #9ca3af;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.08);
    }

    button {
      padding: 14px 18px;
      border-radius: 12px;
      border: none;
      background: #111827;
      color: #fff;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
      box-shadow: none;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      background: #0f172a;
    }

    button:disabled {
      opacity: 0.65;
      cursor: not-allowed;
      box-shadow: none;
    }

    .column-input {
      grid-row: 1;
    }

    .messages {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .column-input {
      width: 100%;
      max-width: 720px;
      overflow: hidden;
      max-height: 1000px;
      transition:
        opacity 0.3s ease,
        transform 0.3s ease,
        max-height 0.4s ease,
        margin 0.4s ease;
    }

    .column-input.is-hidden {
      opacity: 0;
      transform: translateY(-12px);
      max-height: 0;
      margin: 0;
      display: none;
      pointer-events: none;
    }

    .message {
      padding: 0;
      border-radius: 0;
      line-height: 1.6;
      white-space: pre-wrap;
      background: transparent;
    }

    .message.user {
      display: none;
    }

    .response-shell {
      width: min(720px, 100%);
      display: flex;
      flex-direction: column;
      gap: 28px;
      padding: 16px 0 28px;
    }

    /* Animaci√≥n entrada respuesta */
    .response-shell {
      opacity: 0;
      transform: translateY(16px);
      transition: opacity 0.45s ease, transform 0.45s ease;
    }

    .response-shell.is-visible {
      opacity: 1;
      transform: translateY(0);
    }

    .insight-block {
      text-align: center;
      padding: 26px 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .insight-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.36em;
      color: #cbd5e1;
      font-weight: 600;
    }

    .insight-text {
      font-size: 32px;
      font-weight: 600;
      color: #111827;
      line-height: 1.25;
      max-width: 560px;
      margin: 0 auto;
    }

    .insight-subtext {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.6;
      max-width: 520px;
      margin: 0 auto;
    }

    .movement-block {
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 18px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 10px;
      text-align: center;
    }

    .movement-label {
      font-size: 10px;
      letter-spacing: 0.28em;
      text-transform: uppercase;
      color: #9ca3af;
      font-weight: 600;
    }

    .movement-title {
      font-size: 24px;
      font-weight: 600;
      color: #0f172a;
    }

    .movement-subtext {
      font-size: 14px;
      color: #475569;
      line-height: 1.6;
    }

    .movement-note {
      font-size: 12px;
      color: #9ca3af;
    }

    .reasoning-toggle {
      background: transparent;
      border: none;
      color: #9ca3af;
      font-size: 12px;
      letter-spacing: 0;
      text-transform: none;
      cursor: pointer;
      align-self: center;
      padding: 4px 0;
      border-radius: 0;
      box-shadow: none;
      transition: color 0.2s ease;
    }

    .reasoning-toggle:hover {
      background: transparent;
      border-color: transparent;
      transform: none;
      color: #6b7280;
    }

    .analysis-panel {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.35s ease, opacity 0.35s ease;
      display: flex;
      flex-direction: column;
      gap: 16px;
      border-top: 1px solid #e5e7eb;
      padding: 0 6px;
    }

    .analysis-panel.is-open {
      max-height: 1200px;
      opacity: 1;
      padding-top: 18px;
    }

    .analysis-user-card {
      font-size: 12px;
      color: #9ca3af;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .analysis-user-title {
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 10px;
    }

    .analysis-user-body {
      font-size: 12px;
      line-height: 1.5;
      color: #6b7280;
      white-space: pre-wrap;
    }

    .analysis-section {
      border-top: 1px solid #e5e7eb;
      padding-top: 12px;
    }

    .analysis-section-title {
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .analysis-section-body {
      color: #111827;
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    .options-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .decision-intro {
      font-size: 12px;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 4px;
    }

    .option-card {
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px 18px;
      background: #ffffff;
      transition: border-color 0.2s ease, opacity 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 10px;
      cursor: pointer;
    }

    .option-card:hover {
      border-color: #d1d5db;
    }

    .option-card.is-recommended {
      border-color: #cbd5e1;
      background: #f8fafc;
    }

    .option-title {
      font-weight: 600;
      font-size: 16px;
      color: #111827;
      letter-spacing: 0.01em;
    }

    .option-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .option-badge {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #0f172a;
      background: #e2e8f0;
      padding: 4px 8px;
      border-radius: 999px;
      flex-shrink: 0;
    }

    .option-tradeoff {
      font-size: 13px;
      color: #6b7280;
      opacity: 1;
      min-height: 18px;
      line-height: 1.5;
    }

    .option-card.has-tradeoff:hover .option-tradeoff,
    .option-card.has-tradeoff.is-active .option-tradeoff {
      opacity: 1;
    }

    .option-body {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .option-card.is-active .option-body {
      max-height: 400px;
      opacity: 1;
    }

    .option-text {
      font-size: 14px;
      line-height: 1.7;
      color: #111827;
      white-space: pre-wrap;
    }

    .copy-button {
      align-self: flex-start;
      border: none;
      background: none;
      color: #6b7280;
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      padding: 0;
      cursor: pointer;
      min-width: 96px;
    }

    .loader-panel {
      display: none;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-radius: 14px;
      border: 1px dashed #d1d5db;
      background: #f9fafb;
      color: #6b7280;
      font-weight: 600;
      font-size: 13px;
      align-self: center;
    }

    .loader-spinner {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid #d1d5db;
      border-top-color: #111827;
      animation: spin 0.9s linear infinite;
    }

    .loader-desktop {
      display: none;
    }

    .loader-mobile {
      display: none;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes fadeCopy {
      0% {
        opacity: 0;
        transform: translateY(4px);
      }
      20% {
        opacity: 1;
        transform: translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateY(-4px);
      }
    }

    @media (max-width: 1023px) {
      .workspace {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .column {
        border-radius: 16px;
        padding: 18px;
        border: 1px solid #ececec;
      }

      .column-input {
        grid-row: auto;
      }

      .response-shell {
        padding: 8px 0 20px;
      }

      .insight-text {
        font-size: 26px;
      }

      textarea {
        min-height: 180px;
      }

      .loader-desktop {
        display: none;
      }

      .loader-mobile.is-active {
        display: flex;
      }
    }

    @media (min-width: 1024px) {
      .loader-desktop.is-active {
        display: flex;
      }
    }

    .messages.is-focused {
      justify-content: center;
    }

    .closing-line {
      font-size: 12px;
      color: #9ca3af;
      text-align: center;
      padding: 10px 0 0;
    }
  </style>
</head>
<body>

<div class="app-shell">
  <div class="top-bar">
    <div class="app-title">Decision Clarifier</div>
    <button class="menu-button" id="menuBtn">‚ãØ</button>
  </div>
  <div class="menu" id="menu">
    <button id="resetBtn">‚Ü∫ Reiniciar chat</button>
  </div>

  <div class="workspace">
    <section class="column column-input">
      <div class="column-header">Describe la situaci√≥n</div>
      <form class="input-container" id="form">
        <div class="context-selector" id="contextSelector">
          <button type="button" class="context-button active" data-context="General">General</button>
          <button type="button" class="context-button" data-context="Negociaci√≥n">Negociaci√≥n</button>
          <button type="button" class="context-button" data-context="Trabajo / Pol√≠tica interna">Trabajo / Pol√≠tica interna</button>
          <button type="button" class="context-button" data-context="Cliente / Ventas">Cliente / Ventas</button>
          <button type="button" class="context-button" data-context="Carrera / Oferta laboral">Carrera / Oferta laboral</button>
        </div>
        <button type="button" class="advanced-toggle" id="advancedToggle">Ajustes avanzados (opcional)</button>
        <div class="input-row profile-row is-collapsed" id="profileRow">
          <label for="genderSelect" class="profile-label">üë§ Perfil de la persona (opcional)</label>
          <select id="genderSelect">
            <option value="">G√©nero: No especificar</option>
            <option value="hombre">G√©nero: Masculino</option>
            <option value="mujer">G√©nero: Femenino</option>
          </select>
          <select id="ageSelect">
            <option value="">Edad: No especificar</option>
            <option value="18‚Äì25">Edad: 18‚Äì25</option>
            <option value="26‚Äì35">Edad: 26‚Äì35</option>
            <option value="36‚Äì45">Edad: 36‚Äì45</option>
            <option value="45+">Edad: 45+</option>
          </select>
        </div>
        <div class="input-row">
          <textarea id="input" rows="2" placeholder="Describe la situaci√≥n (o pega el texto/email). S√© concreto." autocomplete="off"></textarea>
          <button type="submit">Analizar</button>
          <div class="loader-panel loader-mobile" id="loaderMobile">
            <span class="loader-spinner" aria-hidden="true"></span>
            <span>Analizando situaci√≥n‚Ä¶</span>
          </div>
        </div>
      </form>
    </section>

    <div class="messages" id="messages"></div>
    <div class="closing-line">La claridad no elimina el conflicto. Lo ordena.</div>
  </div>
</div>

<script>
  const API_URL = "https://hotel-chat-proxy.vercel.app/api/t4";

  const messagesEl = document.getElementById("messages");
  const form = document.getElementById("form");
  const input = document.getElementById("input");
  const menuBtn = document.getElementById("menuBtn");
  const menu = document.getElementById("menu");
  const resetBtn = document.getElementById("resetBtn");
  const contextSelector = document.getElementById("contextSelector");
  const contextButtons = contextSelector.querySelectorAll(".context-button");
  const submitButton = form.querySelector("button[type='submit']");
  const columnInput = document.querySelector(".column-input");
  const advancedToggle = document.getElementById("advancedToggle");
  const profileRow = document.getElementById("profileRow");
  const genderSelect = document.getElementById("genderSelect");
  const ageSelect = document.getElementById("ageSelect");
  const loaderMobile = document.getElementById("loaderMobile");

  let messages = [];
  let currentContext = "General";
  let isLoading = false;
  let insightTextEl = null;
  let reasoningToggleEl = null;
  let analysisPanelEl = null;
  let optionsListEl = null;
  let loaderDesktopEl = null;
  let activeOption = null;
  let lastUserText = "";

  const WELCOME = "";

  function addMessage(role, text) {
    const div = document.createElement("div");
    div.className = `message ${role}`;
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function buildUserMessageCard(text) {
    const wrapper = document.createElement("div");
    wrapper.className = "analysis-user-card";

    const title = document.createElement("div");
    title.className = "analysis-user-title";
    title.textContent = "Situaci√≥n analizada";

    const body = document.createElement("div");
    body.className = "analysis-user-body";
    body.textContent = text;

    wrapper.appendChild(title);
    wrapper.appendChild(body);

    return wrapper;
  }

  function buildLoaderPanel(type) {
    const loader = document.createElement("div");
    loader.className = `loader-panel ${type}`;
    loader.innerHTML = `
      <span class="loader-spinner" aria-hidden="true"></span>
      <span>Analizando situaci√≥n‚Ä¶</span>
    `;
    return loader;
  }

  function extractAnalysisSections(text) {
    try {
      const normalized = text.replace(/\r\n/g, "\n").trim();
      const lecturaIndex = normalized.search(/Lectura r[√°a]pida/i);
      const pasandoIndex = normalized.search(/Qu[e√©]\s+est[a√°]\s+pasando/i);
      const estrategiaIndex = normalized.search(/Estrategia/i);
      if (lecturaIndex === -1 || pasandoIndex === -1 || pasandoIndex <= lecturaIndex) {
        return null;
      }

      const lecturaTitleMatch = normalized.match(/Lectura r[√°a]pida/i);
      const pasandoTitleMatch = normalized.match(/Qu[e√©]\s+est[a√°]\s+pasando/i);
      const estrategiaTitleMatch = normalized.match(/Estrategia/i);
      const lecturaTitleRaw = lecturaTitleMatch ? lecturaTitleMatch[0] : "Lectura r√°pida";
      const pasandoTitleRaw = pasandoTitleMatch ? pasandoTitleMatch[0] : "Qu√© est√° pasando";
      const estrategiaTitleRaw = estrategiaTitleMatch ? estrategiaTitleMatch[0] : "Estrategia";
      const lecturaTitle = lecturaTitleRaw.trim();
      const pasandoTitle = pasandoTitleRaw.trim();
      const estrategiaTitle = estrategiaTitleRaw.trim();
      const lecturaBody = normalized
        .slice(lecturaIndex + lecturaTitleRaw.length, pasandoIndex)
        .trim()
        .replace(/^[:\-\s]+/, "");
      let pasandoBody = "";
      let estrategiaBody = "";

      if (estrategiaIndex !== -1 && estrategiaIndex > pasandoIndex) {
        pasandoBody = normalized
          .slice(pasandoIndex + pasandoTitleRaw.length, estrategiaIndex)
          .trim()
          .replace(/^[:\-\s]+/, "");
        estrategiaBody = normalized
          .slice(estrategiaIndex + estrategiaTitleRaw.length)
          .trim()
          .replace(/^[:\-\s]+/, "");
      } else {
        pasandoBody = normalized
          .slice(pasandoIndex + pasandoTitleRaw.length)
          .trim()
          .replace(/^[:\-\s]+/, "");
      }

      const sections = [
        { title: lecturaTitle, body: lecturaBody },
        { title: pasandoTitle, body: pasandoBody }
      ];
      if (estrategiaBody) {
        sections.push({ title: estrategiaTitle, body: estrategiaBody });
      }
      return sections;
    } catch (error) {
      console.error(error);
      return null;
    }
  }

  function buildAnalysisSection(section) {
    const sectionEl = document.createElement("div");
    sectionEl.className = "analysis-section";

    const title = document.createElement("div");
    title.className = "analysis-section-title";
    title.textContent = section.title;

    const body = document.createElement("div");
    body.className = "analysis-section-body";
    body.textContent = section.body;

    sectionEl.appendChild(title);
    if (section.body) {
      sectionEl.appendChild(body);
    }

    return sectionEl;
  }

  function extractFirstSentence(text) {
    let cleaned = text.replace(/^[\s:\-‚Äì‚Äî]+/, "").trim();
    cleaned = cleaned.replace(/^situaci√≥n\s*:/i, "").trim();
    if (!cleaned) return "";
    const match = cleaned.match(/[^.!?]+[.!?]/);
    if (match) {
      return match[0].trim();
    }
    const firstLine = cleaned.split("\n").find(line => line.trim());
    return (firstLine || cleaned).trim();
  }

  function findSectionText(text, startRegex, stopRegexes) {
    const startMatch = text.match(startRegex);
    if (!startMatch) return "";
    const startIndex = text.search(startRegex);
    const start = startIndex + startMatch[0].length;
    let end = text.length;
    stopRegexes.forEach((regex) => {
      const sliceIndex = text.slice(start).search(regex);
      if (sliceIndex !== -1) {
        end = Math.min(end, start + sliceIndex);
      }
    });
    return text.slice(start, end).trim();
  }

  function extractAppleInsight(rawAnalysisText) {
    const fallback =
      "Esta situaci√≥n no est√° definida. Eso, en s√≠ mismo, ya es una decisi√≥n.";
    try {
      if (!rawAnalysisText) return fallback;
      const normalized = rawAnalysisText.replace(/\r\n/g, "\n").trim();
      if (!normalized) return fallback;
      const lecturaSection = findSectionText(
        normalized,
        /Lectura r[√°a]pida/i,
        [/Qu[e√©]\s+est[a√°]\s+pasando/i, /Estrategia/i, /Opc[i√≠]√≥n\s*[A-C]/i]
      );
      if (lecturaSection) {
        const sentence = extractFirstSentence(lecturaSection);
        if (sentence) return sentence;
      }
      const pasandoSection = findSectionText(
        normalized,
        /Qu[e√©]\s+est[a√°]\s+pasando/i,
        [/Estrategia/i, /Opc[i√≠]√≥n\s*[A-C]/i]
      );
      if (pasandoSection) {
        const sentence = extractFirstSentence(pasandoSection);
        if (sentence) return sentence;
      }
      return fallback;
    } catch (error) {
      console.error(error);
      return fallback;
    }
  }

  function extractTradeoffLine(text) {
    const clean = text.replace(/\r\n/g, "\n");
    const lines = clean.split("\n");
    for (const line of lines) {
      const trimmed = line.trim();
      if (/^trade-off:/i.test(trimmed)) {
        return trimmed;
      }
    }
    return "";
  }

  function getOptionDisplayName(text) {
    const clean = text.replace(/\r\n/g, "\n");
    const lines = clean.split("\n");
    const firstLine = lines.find(line => line.trim());
    if (!firstLine) return "";
    const trimmed = firstLine.trim();
    const looksLikeHeading =
      !/^trade-off:/i.test(trimmed) &&
      trimmed.length <= 60 &&
      !/[.!?]$/.test(trimmed);
    return looksLikeHeading ? trimmed : "";
  }

  function stripTradeoffLine(text) {
    const clean = text.replace(/\r\n/g, "\n");
    const lines = clean.split("\n");
    const remaining = lines.filter(line => !/^trade-off:/i.test(line.trim()));
    return remaining.join("\n").trim();
  }

  function setActiveOption(label) {
    activeOption = label;
    if (!optionsListEl) return;
    optionsListEl.querySelectorAll(".option-card").forEach(card => {
      card.classList.toggle("is-active", card.dataset.label === label);
    });
  }

  function addAssistantResponse(analysisText, options) {
    try {
      if (insightTextEl) {
        insightTextEl.textContent = extractAppleInsight(analysisText || "");
      }
      if (analysisPanelEl) {
        analysisPanelEl.innerHTML = "";
        if (analysisText) {
          analysisPanelEl.appendChild(buildUserMessageCard(lastUserText || ""));
          const sections = extractAnalysisSections(analysisText);
          if (sections) {
            sections.forEach(section => {
              analysisPanelEl.appendChild(buildAnalysisSection(section));
            });
          } else {
            const plain = document.createElement("div");
            plain.className = "analysis-section-body";
            plain.textContent = analysisText;
            analysisPanelEl.appendChild(plain);
          }
        }
      }
      if (reasoningToggleEl) {
        reasoningToggleEl.style.display = analysisText ? "inline-flex" : "none";
      }

      if (!optionsListEl) return;
      optionsListEl.innerHTML = "";
      const displayOptions = Array.isArray(options) ? options : [];
      displayOptions.forEach((option) => {
        const optionText = option.text || "";
        const displayName = getOptionDisplayName(optionText);
        const titleText = `${option.label} ‚Äî ${displayName || "OPCI√ìN"}`;
        const tradeoffText = extractTradeoffLine(optionText);
        const bodyText = stripTradeoffLine(optionText);
        const isRecommended =
          /\(\s*RECOMENDADA\s*\)/i.test(titleText) ||
          /\(\s*RECOMENDADA\s*\)/i.test(optionText) ||
          /recomendada/i.test(titleText) ||
          /recomendada/i.test(optionText);
        const card = document.createElement("div");
        card.className = "option-card";
        card.dataset.label = option.label;
        if (isRecommended) {
          card.classList.add("is-recommended");
        }

        const titleRow = document.createElement("div");
        titleRow.className = "option-title-row";

        const title = document.createElement("div");
        title.className = "option-title";
        title.textContent = titleText;
        titleRow.appendChild(title);
        if (isRecommended) {
          const badge = document.createElement("span");
          badge.className = "option-badge";
          badge.textContent = "Recomendada";
          titleRow.appendChild(badge);
        }

        const tradeoff = document.createElement("div");
        tradeoff.className = "option-tradeoff";
        tradeoff.textContent = tradeoffText || "";
        if (tradeoff.textContent) {
          card.classList.add("has-tradeoff");
        }

        const body = document.createElement("div");
        body.className = "option-body";

        const text = document.createElement("div");
        text.className = "option-text";
        text.textContent = bodyText;

        const copyButton = document.createElement("button");
        copyButton.type = "button";
        copyButton.className = "copy-button";
        copyButton.setAttribute("aria-label", "Copiar texto");
        copyButton.textContent = "Copiar texto";

        copyButton.addEventListener("click", async (event) => {
          event.stopPropagation();
          try {
            await navigator.clipboard.writeText(optionText);
            copyButton.textContent = "Copiado ‚úì";
            setTimeout(() => {
              copyButton.textContent = "Copiar texto";
            }, 1200);
          } catch (error) {
            console.error(error);
          }
        });

        body.appendChild(text);
        body.appendChild(copyButton);
        card.appendChild(titleRow);
        card.appendChild(tradeoff);
        card.appendChild(body);
        card.addEventListener("click", () => {
          setActiveOption(activeOption === option.label ? null : option.label);
        });
        optionsListEl.appendChild(card);
      });
      const recommendedOption = displayOptions.find((option) => {
        const optionText = option.text || "";
        const displayName = getOptionDisplayName(optionText);
        const titleText = `${option.label} ‚Äî ${displayName || "OPCI√ìN"}`;
        return (
          /\(\s*RECOMENDADA\s*\)/i.test(titleText) ||
          /\(\s*RECOMENDADA\s*\)/i.test(optionText) ||
          /recomendada/i.test(titleText) ||
          /recomendada/i.test(optionText)
        );
      });
      const defaultLabel = recommendedOption?.label || displayOptions[0]?.label || null;
      setActiveOption(defaultLabel);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    } catch (error) {
      console.error(error);
    }
  }

  function parseResponse(answer) {
    try {
      if (!answer) return { analysis: "", options: [] };
      const normalized = answer.replace(/\r\n/g, "\n");
      const optionRegex = (label) =>
        new RegExp(
          `Opc[i√≠]√≥n\\s*${label}\\s*(?:\\([^\\)]*\\))?\\s*:\\s*([\\s\\S]*?)(?=Opc[i√≠]√≥n\\s*[A-C]\\s*(?:\\(|:)|$)`,
          "i"
        );
      const options = ["A", "B", "C"]
        .map((label) => {
          const match = normalized.match(optionRegex(label));
          return match ? { label, text: match[1].trim() } : null;
        })
        .filter(Boolean);
      const firstOptionIndex = normalized.search(/Opc[i√≠]√≥n\s*[A-C]/i);
      const analysisContent =
        firstOptionIndex !== -1 ? normalized.slice(0, firstOptionIndex).trim() : normalized.trim();
      return { analysis: analysisContent, options };
    } catch (error) {
      console.error(error);
      return { analysis: answer || "", options: [] };
    }
  }

  function setLoading(state) {
    isLoading = state;
    submitButton.disabled = state;
    submitButton.textContent = state ? "Analizando‚Ä¶" : "Analizar";
    loaderMobile.classList.toggle("is-active", state);
    if (loaderDesktopEl) {
      loaderDesktopEl.classList.toggle("is-active", state);
    }
  }

  function loadChat() {
    messages = [];
    if (WELCOME) {
      addMessage("assistant", WELCOME);
    }
  }

  function setContext(context) {
    currentContext = context;
    contextButtons.forEach(button => {
      button.classList.toggle("active", button.dataset.context === context);
    });
  }

  contextButtons.forEach(button => {
    button.addEventListener("click", () => {
      setContext(button.dataset.context);
    });
  });

  advancedToggle.addEventListener("click", () => {
    profileRow.classList.toggle("is-collapsed");
  });

  async function sendMessage(text) {
    lastUserText = text;
    if (columnInput) {
      columnInput.classList.add("is-hidden");
    }
    if (messagesEl) {
      messagesEl.classList.add("is-focused");
    }
    const profileParts = [];
    if (genderSelect.value) {
      profileParts.push(genderSelect.value);
    }
    if (ageSelect.value) {
      profileParts.push(ageSelect.value);
    }
    const profileLine = profileParts.length ? `[Perfil: ${profileParts.join(", ")}]` : "";
    const payloadLines = [`[Contexto: ${currentContext}]`];
    if (profileLine) {
      payloadLines.push(profileLine);
    }
    payloadLines.push(text);
    const payloadFinal = payloadLines.join("\n");

    messagesEl.innerHTML = "";
    messages = [{ role: "user", content: payloadFinal }];

    const assistantShell = document.createElement("div");
    assistantShell.className = "response-shell";

    const insightBlock = document.createElement("div");
    insightBlock.className = "insight-block";

    const insightLabel = document.createElement("div");
    insightLabel.className = "insight-label";
    insightLabel.textContent = "LO QUE REALMENTE EST√Å OCURRIENDO";

    insightTextEl = document.createElement("div");
    insightTextEl.className = "insight-text";
    insightTextEl.textContent =
      "Cuestionamientos p√∫blicos de un socio minoritario sobre decisiones laborales.";

    const insightSubtext = document.createElement("div");
    insightSubtext.className = "insight-subtext";
    insightSubtext.textContent = "No es un desacuerdo puntual, es una erosi√≥n gradual de autoridad.";

    reasoningToggleEl = document.createElement("button");
    reasoningToggleEl.type = "button";
    reasoningToggleEl.className = "reasoning-toggle";
    reasoningToggleEl.textContent = "Ver c√≥mo se lleg√≥ a esta conclusi√≥n";

    insightBlock.appendChild(insightLabel);
    insightBlock.appendChild(insightTextEl);
    insightBlock.appendChild(insightSubtext);
    insightBlock.appendChild(reasoningToggleEl);

    analysisPanelEl = document.createElement("div");
    analysisPanelEl.className = "analysis-panel";

    loaderDesktopEl = buildLoaderPanel("loader-desktop");

    const movementBlock = document.createElement("div");
    movementBlock.className = "movement-block";

    const movementLabel = document.createElement("div");
    movementLabel.className = "movement-label";
    movementLabel.textContent = "MOVIMIENTO RECOMENDADO";

    const movementTitle = document.createElement("div");
    movementTitle.className = "movement-title";
    movementTitle.textContent = "Abrir di√°logo";

    const movementSubtext = document.createElement("div");
    movementSubtext.className = "movement-subtext";
    movementSubtext.textContent =
      "Es la √∫nica opci√≥n que corta la erosi√≥n sin escalar el conflicto ahora.";

    const movementNote = document.createElement("div");
    movementNote.className = "movement-note";
    movementNote.textContent = "Si no haces nada m√°s, esta es la jugada m√°s inteligente.";

    movementBlock.appendChild(movementLabel);
    movementBlock.appendChild(movementTitle);
    movementBlock.appendChild(movementSubtext);
    movementBlock.appendChild(movementNote);

    optionsListEl = document.createElement("div");
    optionsListEl.className = "options-list";

    const decisionIntro = document.createElement("div");
    decisionIntro.className = "decision-intro";
    decisionIntro.textContent = "Ahora toca decidir el pr√≥ximo movimiento.";

    assistantShell.appendChild(insightBlock);
    assistantShell.appendChild(movementBlock);
    assistantShell.appendChild(loaderDesktopEl);
    assistantShell.appendChild(analysisPanelEl);
    assistantShell.appendChild(decisionIntro);
    assistantShell.appendChild(optionsListEl);
    messagesEl.appendChild(assistantShell);
    requestAnimationFrame(() => {
      assistantShell.classList.add("is-visible");
    });

    reasoningToggleEl.addEventListener("click", () => {
      analysisPanelEl.classList.toggle("is-open");
    });

    setLoading(true);
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages })
      });

      const rawText = await res.text();
      let answerText = rawText;
      try {
        const data = JSON.parse(rawText);
        if (data && typeof data.answer === "string") {
          answerText = data.answer;
        }
      } catch (error) {
        console.error(error);
      }

      const parsed = parseResponse(answerText || "");
      addAssistantResponse(parsed.analysis, parsed.options);
      messages.push({ role: "assistant", content: answerText });
    } catch (error) {
      console.error(error);
    } finally {
      setLoading(false);
    }
  }

  form.addEventListener("submit", e => {
    e.preventDefault();
    if (isLoading) return;
    const text = input.value.trim();
    if (!text) return;
    input.value = "";
    input.style.height = "";
    sendMessage(text);
  });

  function autoGrowTextarea() {
    const styles = getComputedStyle(input);
    const lineHeight = parseFloat(styles.lineHeight) || 24;
    const maxHeight = lineHeight * 8;
    input.style.height = "auto";
    input.style.height = `${Math.min(input.scrollHeight, maxHeight)}px`;
  }

  input.addEventListener("input", autoGrowTextarea);
  input.addEventListener("keydown", event => {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      form.requestSubmit();
    }
  });
  autoGrowTextarea();

  menuBtn.onclick = () => menu.classList.toggle("open");
  resetBtn.onclick = () => {
    messages = [];
    messagesEl.innerHTML = "";
    if (WELCOME) {
      addMessage("assistant", WELCOME);
    }
    setContext("General");
    genderSelect.value = "";
    ageSelect.value = "";
    profileRow.classList.add("is-collapsed");
    if (columnInput) {
      columnInput.classList.remove("is-hidden");
    }
    if (messagesEl) {
      messagesEl.classList.remove("is-focused");
    }
    menu.classList.remove("open");
  };

  loadChat();
</script>

</body>
</html>
