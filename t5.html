<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Decision Clarifier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Aclara decisiones humanas. Entiende la situaci√≥n, el riesgo y el pr√≥ximo movimiento." />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f7f6f3;
      color: #111827;
      min-height: 100vh;
    }

    * {
      box-sizing: border-box;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 28px 4px;
      position: relative;
    }

    .app-title {
      font-size: 15px;
      font-weight: 600;
      color: #0f172a;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .menu-button {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: #475569;
    }

    .menu {
      position: absolute;
      right: 28px;
      top: 56px;
      margin-top: 8px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 6px;
      display: none;
      z-index: 5;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }

    .menu.open {
      display: block;
    }

    .menu button {
      background: none;
      color: #0f172a;
      width: 100%;
      text-align: left;
      padding: 8px;
      font-size: 13px;
    }

    .workspace {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
      padding: 24px 16px 42px;
    }

    .column {
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #ececec;
      padding: 22px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .column-header {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 18px;
    }

    .input-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .context-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .context-button {
      padding: 7px 13px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      color: #111827;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
    }

    .context-button:hover {
      border-color: #cbd5f5;
      color: #111827;
    }

    .context-button.active {
      background: #111827;
      color: #fff;
      border-color: #111827;
    }

    .input-row {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .profile-row {
      background: #f9fafb;
      border-radius: 14px;
      border: 1px solid #ececec;
      padding: 14px;
    }

    .profile-row.is-collapsed {
      display: none;
    }

    .advanced-toggle {
      background: none;
      border: none;
      color: #6b7280;
      font-size: 12px;
      font-weight: 600;
      padding: 0;
      cursor: pointer;
      text-align: left;
    }

    .profile-label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
    }

    select {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 13px;
      color: #111827;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    select:focus {
      border-color: #9ca3af;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.08);
    }

    textarea {
      width: 100%;
      padding: 16px 18px;
      font-size: 15px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      outline: none;
      resize: none;
      line-height: 1.7;
      min-height: 220px;
      background: #f9fafb;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    textarea:focus {
      border-color: #9ca3af;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.08);
    }

    button {
      padding: 14px 18px;
      border-radius: 12px;
      border: none;
      background: #111827;
      color: #fff;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
      box-shadow: none;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      background: #0f172a;
    }

    button:disabled {
      opacity: 0.65;
      cursor: not-allowed;
      box-shadow: none;
    }

    .column-input {
      grid-row: 1;
    }

    .messages {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .column-input {
      width: 100%;
      max-width: 720px;
      overflow: hidden;
      max-height: 1000px;
      transition:
        opacity 0.3s ease,
        transform 0.3s ease,
        max-height 0.4s ease,
        margin 0.4s ease;
    }

    .column-input.is-hidden {
      opacity: 0;
      transform: translateY(-12px);
      max-height: 0;
      margin: 0;
      pointer-events: none;
    }

    .message {
      padding: 0;
      border-radius: 0;
      line-height: 1.6;
      white-space: pre-wrap;
      background: transparent;
    }

    .message.user {
      display: none;
    }

    .response-shell {
      width: min(720px, 100%);
      display: flex;
      flex-direction: column;
      gap: 28px;
      padding: 24px 0 36px;
    }

    /* Animaci√≥n entrada respuesta */
    .response-shell {
      opacity: 0;
      transform: translateY(16px);
      transition: opacity 0.45s ease, transform 0.45s ease;
    }

    .response-shell.is-visible {
      opacity: 1;
      transform: translateY(0);
    }

    .insight-block {
      text-align: center;
      padding: 26px 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .insight-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.36em;
      color: #cbd5e1;
      font-weight: 600;
    }

    .insight-text {
      font-size: 32px;
      font-weight: 600;
      color: #111827;
      line-height: 1.25;
      max-width: 560px;
      margin: 0 auto;
    }

    .insight-subtext {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.6;
      max-width: 520px;
      margin: 0 auto;
    }

    .reasoning-toggle {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      color: #374151;
      font-size: 13px;
      letter-spacing: 0.01em;
      text-transform: none;
      cursor: pointer;
      align-self: center;
      padding: 10px 16px;
      border-radius: 12px;
      box-shadow: none;
      transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .reasoning-toggle:hover {
      background: #f8fafc;
      border-color: #d1d5db;
      transform: none;
      color: #1f2937;
    }

    .analysis-panel {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.35s ease, opacity 0.35s ease;
      display: flex;
      flex-direction: column;
      gap: 16px;
      border-top: 1px solid #e5e7eb;
      padding: 0 6px;
    }

    .analysis-panel.is-open {
      max-height: 1200px;
      opacity: 1;
      padding-top: 18px;
    }

    .analysis-user-card {
      font-size: 12px;
      color: #9ca3af;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .analysis-user-title {
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 10px;
    }

    .analysis-user-body {
      font-size: 12px;
      line-height: 1.5;
      color: #6b7280;
      white-space: pre-wrap;
    }

    .analysis-section {
      border-top: 1px solid #e5e7eb;
      padding-top: 12px;
    }

    .analysis-section-title {
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .analysis-section-body {
      color: #111827;
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    .options-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .options-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-weight: 600;
      color: #6b7280;
    }

    .dashboard-card {
      border: 1px solid #e5e7eb;
      border-radius: 18px;
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      background: #ffffff;
    }

    .dashboard-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-weight: 600;
      color: #6b7280;
    }

    .metric-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      font-size: 13px;
      color: #111827;
    }

    .metric-label {
      min-width: 120px;
      font-weight: 600;
      color: #111827;
    }

    .metric-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    .dots {
      display: flex;
      gap: 4px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #e5e7eb;
    }

    .dot.is-active {
      background: #111827;
      opacity: 0.8;
    }

    .metric-level {
      font-size: 12px;
      color: #6b7280;
      min-width: 56px;
      text-align: right;
    }

    .summary-blocks {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .summary-block {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px 18px;
    }

    .summary-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .summary-body {
      font-size: 14px;
      line-height: 1.7;
      color: #111827;
      white-space: pre-wrap;
    }

    .summary-body ul {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 6px;
    }

    .option-card {
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px 18px;
      background: #ffffff;
      transition: border-color 0.2s ease, opacity 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
    }

    .option-card:hover {
      border-color: #d1d5db;
    }

    .option-card.is-recommended {
      border-color: #cbd5e1;
      background: #f8fafc;
    }

    .option-card.is-recommended::before {
      content: "";
      position: absolute;
      left: 0;
      top: 14px;
      bottom: 14px;
      width: 3px;
      border-radius: 999px;
      background: rgba(17, 24, 39, 0.4);
    }

    .option-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .option-title-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .option-index {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f8fafc;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }

    .option-title {
      font-weight: 600;
      font-size: 16px;
      color: #111827;
      letter-spacing: 0.01em;
    }

    .option-tag {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #f1f5f9;
      color: #475569;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .option-tradeoff {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      color: #6b7280;
      opacity: 1;
      min-height: 18px;
    }

    .option-tradeoff-base {
      color: #9ca3af;
    }

    .option-tradeoff-dynamic {
      color: #6b7280;
    }

    .tradeoff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      border-top: 1px solid #e5e7eb;
      padding-top: 10px;
    }

    .tradeoff-col {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      color: #111827;
    }

    .tradeoff-title {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
      color: #6b7280;
    }

    .tradeoff-list {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 4px;
      color: #111827;
    }

    .option-body {
      max-height: none;
      opacity: 1;
      overflow: visible;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .option-text {
      font-size: 14px;
      line-height: 1.7;
      color: #111827;
      white-space: pre-wrap;
    }

    .copy-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .copy-button {
      align-self: flex-start;
      border: 1px solid transparent;
      background: transparent;
      color: #6b7280;
      padding: 0;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .copy-button:hover,
    .copy-button:focus-visible {
      border-color: #e5e7eb;
      background: #f8fafc;
      outline: none;
    }

    .copy-button img {
      width: 18px;
      height: 18px;
      opacity: 0.7;
    }

    .copy-feedback {
      font-size: 12px;
      color: #6b7280;
      opacity: 0;
    }

    .copy-feedback.is-visible {
      animation: fadeCopy 0.9s ease;
    }

    .loader-panel {
      display: none;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-radius: 14px;
      border: 1px dashed #d1d5db;
      background: #f9fafb;
      color: #6b7280;
      font-weight: 600;
      font-size: 13px;
      align-self: center;
    }

    .loader-spinner {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid #d1d5db;
      border-top-color: #111827;
      animation: spin 0.9s linear infinite;
    }

    .loader-panel.is-active {
      display: flex;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes fadeCopy {
      0% {
        opacity: 0;
        transform: translateY(4px);
      }
      20% {
        opacity: 1;
        transform: translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateY(-4px);
      }
    }

    @media (max-width: 1023px) {
      .workspace {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .column {
        border-radius: 16px;
        padding: 18px;
        border: 1px solid #ececec;
      }

      .column-input {
        grid-row: auto;
      }

      .response-shell {
        padding: 8px 0 24px;
      }

      .insight-text {
        font-size: 26px;
      }

      textarea {
        min-height: 180px;
      }

    }

    @media (min-width: 1024px) {
      .loader-mobile {
        display: none;
      }
    }

    .closing-line {
      font-size: 12px;
      color: #9ca3af;
      text-align: center;
      padding: 4px 0 0;
      opacity: 0.7;
    }

    .response-shell.is-loading .insight-block,
    .response-shell.is-loading .dashboard-card,
    .response-shell.is-loading .summary-blocks,
    .response-shell.is-loading .analysis-panel,
    .response-shell.is-loading .options-title,
    .response-shell.is-loading .options-list,
    .response-shell.is-loading .reasoning-toggle {
      display: none;
    }
  </style>
</head>
<body>

<div class="app-shell">
  <div class="top-bar">
    <div class="app-title">Decision Clarifier</div>
    <button class="menu-button" id="menuBtn">‚ãØ</button>
  </div>
  <div class="menu" id="menu">
    <button id="resetBtn">‚Ü∫ Reiniciar chat</button>
  </div>

  <div class="workspace">
    <section class="column column-input">
      <div class="column-header">Describe la situaci√≥n</div>
      <form class="input-container" id="form">
        <div class="context-selector" id="contextSelector">
          <button type="button" class="context-button active" data-context="General">General</button>
          <button type="button" class="context-button" data-context="Negociaci√≥n">Negociaci√≥n</button>
          <button type="button" class="context-button" data-context="Trabajo / Pol√≠tica interna">Trabajo / Pol√≠tica interna</button>
          <button type="button" class="context-button" data-context="Cliente / Ventas">Cliente / Ventas</button>
          <button type="button" class="context-button" data-context="Carrera / Oferta laboral">Carrera / Oferta laboral</button>
        </div>
        <button type="button" class="advanced-toggle" id="advancedToggle">Ajustes avanzados (opcional)</button>
        <div class="input-row profile-row is-collapsed" id="profileRow">
          <label for="genderSelect" class="profile-label">üë§ Perfil de la persona (opcional)</label>
          <select id="genderSelect">
            <option value="">G√©nero: No especificar</option>
            <option value="hombre">G√©nero: Masculino</option>
            <option value="mujer">G√©nero: Femenino</option>
          </select>
          <select id="ageSelect">
            <option value="">Edad: No especificar</option>
            <option value="18‚Äì25">Edad: 18‚Äì25</option>
            <option value="26‚Äì35">Edad: 26‚Äì35</option>
            <option value="36‚Äì45">Edad: 36‚Äì45</option>
            <option value="45+">Edad: 45+</option>
          </select>
        </div>
        <div class="input-row">
          <textarea id="input" rows="2" placeholder="Describe la situaci√≥n (o pega el texto/email). S√© concreto." autocomplete="off"></textarea>
          <button type="submit">Analizar</button>
          <div class="loader-panel loader-mobile" id="loaderMobile">
            <span class="loader-spinner" aria-hidden="true"></span>
            <span>Ordenando la situaci√≥n‚Ä¶</span>
          </div>
        </div>
      </form>
    </section>

    <div class="messages" id="messages"></div>
    <div class="closing-line">La claridad no elimina el conflicto. Lo ordena.</div>
  </div>
</div>

<script>
  const API_URL = "https://hotel-chat-proxy.vercel.app/api/t4";

  const messagesEl = document.getElementById("messages");
  const form = document.getElementById("form");
  const input = document.getElementById("input");
  const menuBtn = document.getElementById("menuBtn");
  const menu = document.getElementById("menu");
  const resetBtn = document.getElementById("resetBtn");
  const contextSelector = document.getElementById("contextSelector");
  const contextButtons = contextSelector.querySelectorAll(".context-button");
  const submitButton = form.querySelector("button[type='submit']");
  const columnInput = document.querySelector(".column-input");
  const advancedToggle = document.getElementById("advancedToggle");
  const profileRow = document.getElementById("profileRow");
  const genderSelect = document.getElementById("genderSelect");
  const ageSelect = document.getElementById("ageSelect");
  const loaderMobile = document.getElementById("loaderMobile");
  const closingLine = document.querySelector(".closing-line");

  let messages = [];
  let currentContext = "General";
  let isLoading = false;
  let insightTextEl = null;
  let insightSubtextEl = null;
  let reasoningToggleEl = null;
  let analysisPanelEl = null;
  let optionsListEl = null;
  let loaderDesktopEl = null;
  let currentResponseShell = null;
  let summaryBlocksEl = null;
  let dashboardEl = null;
  let lastUserText = "";

  const WELCOME = "";

  function addMessage(role, text) {
    const div = document.createElement("div");
    div.className = `message ${role}`;
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function buildUserMessageCard(text) {
    const wrapper = document.createElement("div");
    wrapper.className = "analysis-user-card";

    const title = document.createElement("div");
    title.className = "analysis-user-title";
    title.textContent = "Situaci√≥n analizada";

    const body = document.createElement("div");
    body.className = "analysis-user-body";
    body.textContent = text;

    wrapper.appendChild(title);
    wrapper.appendChild(body);

    return wrapper;
  }

  function buildLoaderPanel(type) {
    const loader = document.createElement("div");
    loader.className = `loader-panel ${type}`;
    loader.innerHTML = `
      <span class="loader-spinner" aria-hidden="true"></span>
      <span>Ordenando la situaci√≥n‚Ä¶</span>
    `;
    return loader;
  }

  function extractAnalysisSections(text) {
    try {
      const normalized = text.replace(/\r\n/g, "\n").trim();
      const lecturaIndex = normalized.search(/Lectura r[√°a]pida/i);
      const pasandoIndex = normalized.search(/Qu[e√©]\s+est[a√°]\s+pasando/i);
      const estrategiaIndex = normalized.search(/Estrategia/i);
      if (lecturaIndex === -1 || pasandoIndex === -1 || pasandoIndex <= lecturaIndex) {
        return null;
      }

      const lecturaTitleMatch = normalized.match(/Lectura r[√°a]pida/i);
      const pasandoTitleMatch = normalized.match(/Qu[e√©]\s+est[a√°]\s+pasando/i);
      const estrategiaTitleMatch = normalized.match(/Estrategia/i);
      const lecturaTitleRaw = lecturaTitleMatch ? lecturaTitleMatch[0] : "Lectura r√°pida";
      const pasandoTitleRaw = pasandoTitleMatch ? pasandoTitleMatch[0] : "Qu√© est√° pasando";
      const estrategiaTitleRaw = estrategiaTitleMatch ? estrategiaTitleMatch[0] : "Estrategia";
      const lecturaTitle = lecturaTitleRaw.trim();
      const pasandoTitle = pasandoTitleRaw.trim();
      const estrategiaTitle = estrategiaTitleRaw.trim();
      const lecturaBody = normalized
        .slice(lecturaIndex + lecturaTitleRaw.length, pasandoIndex)
        .trim()
        .replace(/^[:\-\s]+/, "");
      let pasandoBody = "";
      let estrategiaBody = "";

      if (estrategiaIndex !== -1 && estrategiaIndex > pasandoIndex) {
        pasandoBody = normalized
          .slice(pasandoIndex + pasandoTitleRaw.length, estrategiaIndex)
          .trim()
          .replace(/^[:\-\s]+/, "");
        estrategiaBody = normalized
          .slice(estrategiaIndex + estrategiaTitleRaw.length)
          .trim()
          .replace(/^[:\-\s]+/, "");
      } else {
        pasandoBody = normalized
          .slice(pasandoIndex + pasandoTitleRaw.length)
          .trim()
          .replace(/^[:\-\s]+/, "");
      }

      const sections = [
        { title: lecturaTitle, body: lecturaBody },
        { title: pasandoTitle, body: pasandoBody }
      ];
      if (estrategiaBody) {
        sections.push({ title: estrategiaTitle, body: estrategiaBody });
      }
      return sections;
    } catch (error) {
      console.error(error);
      return null;
    }
  }

  function buildAnalysisSection(section) {
    const sectionEl = document.createElement("div");
    sectionEl.className = "analysis-section";

    const title = document.createElement("div");
    title.className = "analysis-section-title";
    title.textContent = section.title;

    const body = document.createElement("div");
    body.className = "analysis-section-body";
    body.textContent = section.body;

    sectionEl.appendChild(title);
    if (section.body) {
      sectionEl.appendChild(body);
    }

    return sectionEl;
  }

  function extractFirstSentence(text) {
    let cleaned = text.replace(/^[\s:\-‚Äì‚Äî]+/, "").trim();
    cleaned = cleaned.replace(/^situaci√≥n\s*:/i, "").trim();
    if (!cleaned) return "";
    const match = cleaned.match(/[^.!?]+[.!?]/);
    if (match) {
      return match[0].trim();
    }
    const firstLine = cleaned.split("\n").find(line => line.trim());
    return (firstLine || cleaned).trim();
  }

  function trimToSentences(text, count = 2) {
    if (!text) return "";
    const sentences = text.split(/(?<=[.!?])\s+/).filter(Boolean);
    return sentences.slice(0, count).join(" ").trim();
  }

  function extractBulletCandidates(text) {
    if (!text) return [];
    const lines = text
      .split("\n")
      .map(line => line.replace(/^[-*‚Ä¢]\s*/, "").trim())
      .filter(Boolean);
    if (lines.length >= 3) return lines;
    const sentences = text
      .split(/(?<=[.!?])\s+/)
      .map(sentence => sentence.trim())
      .filter(Boolean);
    return sentences.length ? sentences : lines;
  }

  function findSectionText(text, startRegex, stopRegexes) {
    const startMatch = text.match(startRegex);
    if (!startMatch) return "";
    const startIndex = text.search(startRegex);
    const start = startIndex + startMatch[0].length;
    let end = text.length;
    stopRegexes.forEach((regex) => {
      const sliceIndex = text.slice(start).search(regex);
      if (sliceIndex !== -1) {
        end = Math.min(end, start + sliceIndex);
      }
    });
    return text.slice(start, end).trim();
  }

  function levelText(level) {
    if (level <= 2) return "Bajo";
    if (level <= 3) return "Medio";
    return "Alto";
  }

  function levelTextFor(labelGender, level) {
    if (level <= 2) return labelGender === "f" ? "Baja" : "Bajo";
    if (level <= 3) return labelGender === "f" ? "Media" : "Medio";
    return labelGender === "f" ? "Alta" : "Alto";
  }

  function clampMetric(value) {
    return Math.min(5, Math.max(1, value));
  }

  function parseLevelKeyword(text) {
    if (!text) return null;
    const lower = text.toLowerCase();
    if (lower.includes("muy alto") || lower.includes("cr√≠tico")) return 5;
    if (lower.includes("alto")) return 4;
    if (lower.includes("medio") || lower.includes("media")) return 3;
    if (lower.includes("bajo") || lower.includes("baja")) return 2;
    return null;
  }

  function deriveMetricsFromAnalysis(analysisText) {
    const defaults = {
      risk: 3,
      urgency: 3,
      ambiguity: 3,
      inactionCost: 3
    };
    if (!analysisText) return defaults;
    const normalized = analysisText.replace(/\r\n/g, "\n");
    const lectura = findSectionText(
      normalized,
      /Lectura r[√°a]pida/i,
      [/Qu[e√©]\s+est[a√°]\s+pasando/i, /Estrategia/i, /Opc[i√≠]√≥n\s*[A-C]/i]
    );
    const combined = `${lectura}\n${normalized}`.toLowerCase();
    const metrics = { ...defaults };

    if (lectura) {
      const lines = lectura.split("\n").map(line => line.trim()).filter(Boolean);
      lines.forEach(line => {
        if (/riesgo/i.test(line)) {
          const level = parseLevelKeyword(line);
          if (level) metrics.risk = level;
        }
        if (/ambig[u√º]edad|incertidumbre/i.test(line)) {
          const level = parseLevelKeyword(line);
          if (level) metrics.ambiguity = level;
        }
        if (/urgencia|urgente/i.test(line)) {
          const level = parseLevelKeyword(line);
          if (level) metrics.urgency = level;
        }
        if (/costo|coste|p[e√©]rdida|consecuencia/i.test(line)) {
          const level = parseLevelKeyword(line);
          if (level) metrics.inactionCost = level;
        }
      });
    }

    if (metrics.urgency === defaults.urgency && /urgente|inmediato|ahora|ya\b/i.test(combined)) {
      metrics.urgency = 4;
    }
    if (metrics.ambiguity === defaults.ambiguity && /incertidumbre|ambigu|no est[a√°] claro|difuso/i.test(combined)) {
      metrics.ambiguity = 4;
    }
    if (metrics.risk === defaults.risk && /riesgo|p[e√©]rdida|expuesto|grave/i.test(combined)) {
      metrics.risk = 4;
    }
    if (metrics.inactionCost === defaults.inactionCost && /coste|costo|p[e√©]rdida|consecuencia/i.test(combined)) {
      metrics.inactionCost = 4;
    }

    return {
      risk: clampMetric(metrics.risk),
      urgency: clampMetric(metrics.urgency),
      ambiguity: clampMetric(metrics.ambiguity),
      inactionCost: clampMetric(metrics.inactionCost)
    };
  }

  function buildDecisionDashboard(metrics) {
    const dashboard = document.createElement("div");
    dashboard.className = "dashboard-card";

    const title = document.createElement("div");
    title.className = "dashboard-title";
    title.textContent = "Decision Dashboard";
    dashboard.appendChild(title);

    const rows = [
      { key: "risk", label: "Riesgo", gender: "m" },
      { key: "urgency", label: "Urgencia", gender: "f" },
      { key: "ambiguity", label: "Ambig√ºedad", gender: "f" },
      { key: "inactionCost", label: "Costo de no actuar", gender: "m" }
    ];

    rows.forEach((row) => {
      const level = metrics[row.key];
      const rowEl = document.createElement("div");
      rowEl.className = "metric-row";

      const label = document.createElement("div");
      label.className = "metric-label";
      label.textContent = row.label;

      const indicator = document.createElement("div");
      indicator.className = "metric-indicator";

      const dots = document.createElement("div");
      dots.className = "dots";
      for (let i = 1; i <= 5; i += 1) {
        const dot = document.createElement("span");
        dot.className = "dot";
        if (i <= level) {
          dot.classList.add("is-active");
        }
        dots.appendChild(dot);
      }

      const levelEl = document.createElement("div");
      levelEl.className = "metric-level";
      levelEl.textContent = `${levelTextFor(row.gender, level)}`;

      indicator.appendChild(dots);
      indicator.appendChild(levelEl);

      rowEl.appendChild(label);
      rowEl.appendChild(indicator);
      dashboard.appendChild(rowEl);
    });

    return dashboard;
  }

  function extractSubInsight(analysisText, context) {
    const fallbacks = {
      "Negociaci√≥n": "El riesgo es el precedente, no el n√∫mero.",
      "Trabajo / Pol√≠tica interna": "La ambig√ºedad est√° debilitando el control.",
      "Cliente / Ventas": "El marco acordado est√° siendo probado.",
      "Carrera / Oferta laboral": "Decidir tarde tambi√©n es una decisi√≥n.",
      "General": "Lo cr√≠tico es el marco, no el detalle."
    };
    if (analysisText) {
      const normalized = analysisText.replace(/\r\n/g, "\n");
      const pasando = findSectionText(
        normalized,
        /Qu[e√©]\s+est[a√°]\s+pasando/i,
        [/Estrategia/i, /Opc[i√≠]√≥n\s*[A-C]/i]
      );
      const lectura = findSectionText(
        normalized,
        /Lectura r[√°a]pida/i,
        [/Qu[e√©]\s+est[a√°]\s+pasando/i, /Estrategia/i]
      );
      const candidate = extractFirstSentence(pasando || lectura);
      if (candidate) {
        return candidate.length > 110 ? `${candidate.slice(0, 107).trim()}‚Ä¶` : candidate;
      }
    }
    return fallbacks[context] || fallbacks.General;
  }

  function extractAppleInsight(rawAnalysisText) {
    const fallback =
      "Esta situaci√≥n no est√° definida. Eso, en s√≠ mismo, ya es una decisi√≥n.";
    try {
      if (!rawAnalysisText) return fallback;
      const normalized = rawAnalysisText.replace(/\r\n/g, "\n").trim();
      if (!normalized) return fallback;
      const lecturaSection = findSectionText(
        normalized,
        /Lectura r[√°a]pida/i,
        [/Qu[e√©]\s+est[a√°]\s+pasando/i, /Estrategia/i, /Opc[i√≠]√≥n\s*[A-C]/i]
      );
      if (lecturaSection) {
        const sentence = extractFirstSentence(lecturaSection);
        if (sentence) return sentence;
      }
      const pasandoSection = findSectionText(
        normalized,
        /Qu[e√©]\s+est[a√°]\s+pasando/i,
        [/Estrategia/i, /Opc[i√≠]√≥n\s*[A-C]/i]
      );
      if (pasandoSection) {
        const sentence = extractFirstSentence(pasandoSection);
        if (sentence) return sentence;
      }
      return fallback;
    } catch (error) {
      console.error(error);
      return fallback;
    }
  }

  function extractTradeoffLine(text) {
    const clean = text.replace(/\r\n/g, "\n").trim();
    if (!clean) return "";
    const lines = clean.split("\n").map(line => line.trim()).filter(Boolean);
    if (lines.length > 1) {
      return lines[0].slice(0, 120);
    }
    const sentences = clean.split(/(?<=[.!?])\s+/).filter(Boolean);
    if (sentences.length > 1) {
      return sentences[0].trim().slice(0, 120);
    }
    return "";
  }

  function deriveGainsLosses(optionText, label) {
    const fallback = {
      A: {
        gains: ["Bajas tensi√≥n hoy", "Ganas tiempo"],
        losses: ["Pierdes control"]
      },
      B: {
        gains: ["Recuperas marco", "Alineas expectativas"],
        losses: ["Aceptas fricci√≥n"]
      },
      C: {
        gains: ["Cortas ambig√ºedad", "Fijas l√≠mites"],
        losses: ["Escalas conflicto"]
      }
    };
    if (!optionText) return fallback[label] || fallback.A;
    const sentences = optionText
      .split(/(?<=[.!?])\s+/)
      .map(sentence => sentence.trim())
      .filter(Boolean);
    const gains = sentences.filter(sentence =>
      /permite|logras|ayuda|mantiene|protege|abre|recupera|alineas|gana/i.test(sentence)
    );
    const losses = sentences.filter(sentence =>
      /pero|riesgo|puede|sin embargo|costo|coste|sacrific|expon/i.test(sentence)
    );
    const result = {
      gains: gains.slice(0, 2),
      losses: losses.slice(0, 1)
    };
    const fallbackData = fallback[label] || fallback.A;
    while (result.gains.length < 2) {
      result.gains.push(fallbackData.gains[result.gains.length]);
    }
    if (result.losses.length < 1) {
      result.losses.push(fallbackData.losses[0]);
    }
    return result;
  }

  function buildOptionDynamicLine(optionText) {
    if (!optionText) return "";
    let cleaned = optionText.replace(/\r\n/g, "\n").trim();
    cleaned = cleaned.replace(/^opci[o√≥]n\s*[A-C]\s*[:\-‚Äì‚Äî]\s*/i, "").trim();
    const candidate = trimToSentences(cleaned, 2);
    return candidate || cleaned;
  }

  function addAssistantResponse(analysisText, options, recommendation) {
    try {
      if (insightTextEl) {
        insightTextEl.textContent = extractAppleInsight(analysisText || "");
      }
      if (insightSubtextEl) {
        insightSubtextEl.textContent = extractSubInsight(analysisText || "", currentContext);
      }
      if (dashboardEl) {
        const metrics = deriveMetricsFromAnalysis(analysisText || "");
        const nextDashboard = buildDecisionDashboard(metrics);
        dashboardEl.replaceWith(nextDashboard);
        dashboardEl = nextDashboard;
      }
      if (summaryBlocksEl) {
        summaryBlocksEl.innerHTML = "";
        if (analysisText) {
          const sections = extractAnalysisSections(analysisText);
          if (sections) {
            const pasando = sections.find(section => /qu[e√©]\s+est[a√°]\s+pasando/i.test(section.title));
            const estrategia = sections.find(section => /estrategia/i.test(section.title));
            if (pasando && pasando.body) {
              const block = document.createElement("div");
              block.className = "summary-block";
              const title = document.createElement("div");
              title.className = "summary-title";
              title.textContent = "Qu√© est√° pasando";
              const body = document.createElement("div");
              body.className = "summary-body";
              body.textContent = trimToSentences(pasando.body, 2) || pasando.body;
              block.appendChild(title);
              block.appendChild(body);
              summaryBlocksEl.appendChild(block);
            }
            if (estrategia && estrategia.body) {
              const block = document.createElement("div");
              block.className = "summary-block";
              const title = document.createElement("div");
              title.className = "summary-title";
              title.textContent = "Marco recomendado";
              const body = document.createElement("div");
              body.className = "summary-body";
              const list = document.createElement("ul");
              extractBulletCandidates(estrategia.body).slice(0, 3).forEach((item) => {
                const li = document.createElement("li");
                li.textContent = item;
                list.appendChild(li);
              });
              if (list.children.length) {
                body.appendChild(list);
              } else {
                body.textContent = estrategia.body;
              }
              block.appendChild(title);
              block.appendChild(body);
              summaryBlocksEl.appendChild(block);
            }
          }
        }
      }
      if (analysisPanelEl) {
        analysisPanelEl.innerHTML = "";
        if (analysisText) {
          analysisPanelEl.appendChild(buildUserMessageCard(lastUserText || ""));
          const sections = extractAnalysisSections(analysisText);
          if (sections) {
            sections.forEach(section => {
              analysisPanelEl.appendChild(buildAnalysisSection(section));
            });
          } else {
            const plain = document.createElement("div");
            plain.className = "analysis-section-body";
            plain.textContent = analysisText;
            analysisPanelEl.appendChild(plain);
          }
        }
      }
      if (reasoningToggleEl) {
        reasoningToggleEl.style.display = analysisText ? "inline-flex" : "none";
      }

      if (!optionsListEl) return;
      optionsListEl.innerHTML = "";
      const optionTitles = {
        A: "Esperar",
        B: "Abrir di√°logo",
        C: "Forzar definici√≥n"
      };
      const optionConsequences = {
        A: "Limpia la tensi√≥n inmediata.",
        B: "Reordena el marco.",
        C: "Restablece autoridad."
      };
      const optionOrder = ["B", "A", "C"];
      const normalizedRecommendation = recommendation && ["A", "B", "C"].includes(recommendation)
        ? recommendation
        : null;
      const resolvedOrder = normalizedRecommendation
        ? [normalizedRecommendation, ...optionOrder.filter(label => label !== normalizedRecommendation)]
        : optionOrder;
      const displayOptions = resolvedOrder
        .map(label => options.find(option => option.label === label))
        .filter(Boolean);
      displayOptions.forEach((option, index) => {
        const displayIndex = index + 1;
        const card = document.createElement("div");
        card.className = "option-card";
        card.dataset.label = option.label;
        if (normalizedRecommendation && option.label === normalizedRecommendation) {
          card.classList.add("is-recommended");
        }

        const header = document.createElement("div");
        header.className = "option-header";

        const titleWrap = document.createElement("div");
        titleWrap.className = "option-title-wrap";

        const indexBadge = document.createElement("div");
        indexBadge.className = "option-index";
        indexBadge.textContent = displayIndex;

        const title = document.createElement("div");
        title.className = "option-title";
        title.textContent = `Opci√≥n ${displayIndex} ‚Äî ${optionTitles[option.label] || "Opci√≥n"}`;
        titleWrap.appendChild(indexBadge);
        titleWrap.appendChild(title);
        header.appendChild(titleWrap);

        if (normalizedRecommendation && option.label === normalizedRecommendation && displayIndex === 1) {
          const tag = document.createElement("div");
          tag.className = "option-tag";
          tag.textContent = "Recomendada";
          header.appendChild(tag);
        }

        const tradeoff = document.createElement("div");
        tradeoff.className = "option-tradeoff";
        const tradeoffBase = document.createElement("div");
        tradeoffBase.className = "option-tradeoff-base";
        tradeoffBase.textContent = optionConsequences[option.label] || "";
        const tradeoffDynamic = document.createElement("div");
        tradeoffDynamic.className = "option-tradeoff-dynamic";
        tradeoffDynamic.textContent = buildOptionDynamicLine(option.text);
        if (tradeoffBase.textContent) {
          tradeoff.appendChild(tradeoffBase);
        }
        if (tradeoffDynamic.textContent) {
          tradeoff.appendChild(tradeoffDynamic);
        }

        const tradeoffGrid = document.createElement("div");
        tradeoffGrid.className = "tradeoff-grid";
        const derivedTradeoff = deriveGainsLosses(option.text, option.label);

        const gainsCol = document.createElement("div");
        gainsCol.className = "tradeoff-col";
        const gainsTitle = document.createElement("div");
        gainsTitle.className = "tradeoff-title";
        gainsTitle.textContent = "Ganas";
        const gainsList = document.createElement("ul");
        gainsList.className = "tradeoff-list";
        derivedTradeoff.gains.slice(0, 2).forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          gainsList.appendChild(li);
        });
        gainsCol.appendChild(gainsTitle);
        gainsCol.appendChild(gainsList);

        const lossesCol = document.createElement("div");
        lossesCol.className = "tradeoff-col";
        const lossesTitle = document.createElement("div");
        lossesTitle.className = "tradeoff-title";
        lossesTitle.textContent = "Pierdes";
        const lossesList = document.createElement("ul");
        lossesList.className = "tradeoff-list";
        derivedTradeoff.losses.slice(0, 1).forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          lossesList.appendChild(li);
        });
        lossesCol.appendChild(lossesTitle);
        lossesCol.appendChild(lossesList);

        tradeoffGrid.appendChild(gainsCol);
        tradeoffGrid.appendChild(lossesCol);

        const body = document.createElement("div");
        body.className = "option-body";

        const copyButton = document.createElement("button");
        copyButton.type = "button";
        copyButton.className = "copy-button";
        copyButton.setAttribute("aria-label", "Copiar");
        copyButton.setAttribute("title", "Copiar");
        const copyIcon = document.createElement("img");
        copyIcon.src = "/iconos/copy.svg";
        copyIcon.alt = "";
        copyIcon.setAttribute("aria-hidden", "true");
        copyButton.appendChild(copyIcon);

        const copyFeedback = document.createElement("span");
        copyFeedback.className = "copy-feedback";
        copyFeedback.textContent = "Copiado ‚úì";

        copyButton.addEventListener("click", async (event) => {
          event.stopPropagation();
          try {
            await navigator.clipboard.writeText(option.text);
            copyFeedback.classList.remove("is-visible");
            void copyFeedback.offsetWidth;
            copyFeedback.classList.add("is-visible");
            setTimeout(() => {
              copyFeedback.classList.remove("is-visible");
            }, 900);
          } catch (error) {
            console.error(error);
          }
        });

        const copyRow = document.createElement("div");
        copyRow.className = "copy-row";
        copyRow.appendChild(copyButton);
        copyRow.appendChild(copyFeedback);
        body.appendChild(copyRow);
        card.appendChild(header);
        card.appendChild(tradeoff);
        card.appendChild(tradeoffGrid);
        card.appendChild(body);
        optionsListEl.appendChild(card);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    } catch (error) {
      console.error(error);
    }
  }

  function parseResponse(answer) {
    try {
      if (!answer) return { analysis: "", options: [], recommendation: "" };
      const normalized = answer.replace(/\r\n/g, "\n");
      const recommendationMatch = normalized.match(/RECOMENDACI[√ìO]N\s*:\s*([A-C])/i);
      const recommendation = recommendationMatch ? recommendationMatch[1].toUpperCase() : "";
      const cleaned = normalized.replace(/^\s*RECOMENDACI[√ìO]N\s*:\s*[A-C]\s*$/gim, "").trim();
      const optionRegex = (label) =>
        new RegExp(
          `Opc[i√≠]√≥n\\s*${label}\\s*(?:\\([^\\)]*\\))?\\s*:\\s*([\\s\\S]*?)(?=Opc[i√≠]√≥n\\s*[A-C]\\s*(?:\\(|:)|$)`,
          "i"
        );
      const options = ["A", "B", "C"]
        .map((label) => {
          const match = cleaned.match(optionRegex(label));
          return match ? { label, text: match[1].trim() } : null;
        })
        .filter(Boolean);
      const firstOptionIndex = cleaned.search(/Opc[i√≠]√≥n\s*[A-C]/i);
      const analysisContent =
        firstOptionIndex !== -1 ? cleaned.slice(0, firstOptionIndex).trim() : cleaned.trim();
      return { analysis: analysisContent, options, recommendation };
    } catch (error) {
      console.error(error);
      return { analysis: answer || "", options: [], recommendation: "" };
    }
  }

  function setLoading(state) {
    isLoading = state;
    submitButton.disabled = state;
    submitButton.textContent = state ? "Analizando‚Ä¶" : "Analizar";
    loaderMobile.classList.toggle("is-active", state);
    if (loaderDesktopEl) {
      loaderDesktopEl.classList.toggle("is-active", state);
    }
    if (currentResponseShell) {
      currentResponseShell.classList.toggle("is-loading", state);
    }
  }

  function loadChat() {
    messages = [];
    if (WELCOME) {
      addMessage("assistant", WELCOME);
    }
  }

  function setContext(context) {
    currentContext = context;
    contextButtons.forEach(button => {
      button.classList.toggle("active", button.dataset.context === context);
    });
  }

  contextButtons.forEach(button => {
    button.addEventListener("click", () => {
      setContext(button.dataset.context);
    });
  });

  advancedToggle.addEventListener("click", () => {
    profileRow.classList.toggle("is-collapsed");
  });

  async function sendMessage(text) {
    lastUserText = text;
    if (columnInput) {
      columnInput.classList.add("is-hidden");
    }
    const profileParts = [];
    if (genderSelect.value) {
      profileParts.push(genderSelect.value);
    }
    if (ageSelect.value) {
      profileParts.push(ageSelect.value);
    }
    const profileLine = profileParts.length ? `[Perfil: ${profileParts.join(", ")}]` : "";
    const payloadLines = [`[Contexto: ${currentContext}]`];
    if (profileLine) {
      payloadLines.push(profileLine);
    }
    payloadLines.push(text);
    const payloadFinal = payloadLines.join("\n");

    messagesEl.innerHTML = "";
    messages = [{ role: "user", content: payloadFinal }];

    const assistantShell = document.createElement("div");
    assistantShell.className = "response-shell is-loading";
    currentResponseShell = assistantShell;
    if (closingLine) {
      closingLine.style.display = "none";
    }

    const insightBlock = document.createElement("div");
    insightBlock.className = "insight-block";

    const insightLabel = document.createElement("div");
    insightLabel.className = "insight-label";
    insightLabel.textContent = "LO QUE REALMENTE EST√Å OCURRIENDO";

    insightTextEl = document.createElement("div");
    insightTextEl.className = "insight-text";
    insightTextEl.textContent = "";

    insightSubtextEl = document.createElement("div");
    insightSubtextEl.className = "insight-subtext";
    insightSubtextEl.textContent = "";

    reasoningToggleEl = document.createElement("button");
    reasoningToggleEl.type = "button";
    reasoningToggleEl.className = "reasoning-toggle";
    reasoningToggleEl.textContent = "Ver c√≥mo se lleg√≥ a esta conclusi√≥n";
    reasoningToggleEl.style.display = "none";

    insightBlock.appendChild(insightLabel);
    insightBlock.appendChild(insightTextEl);
    insightBlock.appendChild(insightSubtextEl);
    analysisPanelEl = document.createElement("div");
    analysisPanelEl.className = "analysis-panel";

    loaderDesktopEl = buildLoaderPanel("loader-desktop");

    dashboardEl = buildDecisionDashboard(deriveMetricsFromAnalysis(""));

    summaryBlocksEl = document.createElement("div");
    summaryBlocksEl.className = "summary-blocks";

    const optionsTitleEl = document.createElement("div");
    optionsTitleEl.className = "options-title";
    optionsTitleEl.textContent = "Opciones:";

    optionsListEl = document.createElement("div");
    optionsListEl.className = "options-list";

    assistantShell.appendChild(insightBlock);
    assistantShell.appendChild(loaderDesktopEl);
    assistantShell.appendChild(dashboardEl);
    assistantShell.appendChild(summaryBlocksEl);
    assistantShell.appendChild(optionsTitleEl);
    assistantShell.appendChild(optionsListEl);
    assistantShell.appendChild(reasoningToggleEl);
    assistantShell.appendChild(analysisPanelEl);
    messagesEl.appendChild(assistantShell);
    requestAnimationFrame(() => {
      assistantShell.classList.add("is-visible");
    });

    reasoningToggleEl.addEventListener("click", () => {
      analysisPanelEl.classList.toggle("is-open");
      const isOpen = analysisPanelEl.classList.contains("is-open");
      reasoningToggleEl.textContent = isOpen
        ? "Ocultar an√°lisis"
        : "Ver c√≥mo se lleg√≥ a esta conclusi√≥n";
    });

    setLoading(true);
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages })
      });

      const rawText = await res.text();
      let answerText = rawText;
      try {
        const data = JSON.parse(rawText);
        if (data && typeof data.answer === "string") {
          answerText = data.answer;
        }
      } catch (error) {
        console.error(error);
      }

      const parsed = parseResponse(answerText || "");
      addAssistantResponse(parsed.analysis, parsed.options, parsed.recommendation);
      messages.push({ role: "assistant", content: answerText });
    } catch (error) {
      console.error(error);
    } finally {
      setLoading(false);
    }
  }

  form.addEventListener("submit", e => {
    e.preventDefault();
    if (isLoading) return;
    const text = input.value.trim();
    if (!text) return;
    input.value = "";
    input.style.height = "";
    sendMessage(text);
  });

  function autoGrowTextarea() {
    const styles = getComputedStyle(input);
    const lineHeight = parseFloat(styles.lineHeight) || 24;
    const maxHeight = lineHeight * 8;
    input.style.height = "auto";
    input.style.height = `${Math.min(input.scrollHeight, maxHeight)}px`;
  }

  input.addEventListener("input", autoGrowTextarea);
  input.addEventListener("keydown", event => {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      form.requestSubmit();
    }
  });
  autoGrowTextarea();

  menuBtn.onclick = () => menu.classList.toggle("open");
  resetBtn.onclick = () => {
    messages = [];
    messagesEl.innerHTML = "";
    if (WELCOME) {
      addMessage("assistant", WELCOME);
    }
    setContext("General");
    genderSelect.value = "";
    ageSelect.value = "";
    profileRow.classList.add("is-collapsed");
    if (columnInput) {
      columnInput.classList.remove("is-hidden");
    }
    menu.classList.remove("open");
    if (closingLine) {
      closingLine.style.display = "";
    }
  };

  loadChat();
</script>

</body>
</html>
